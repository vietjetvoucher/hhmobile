<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.5, minimum-scale=0.5, maximum-scale=2.0, user-scalable=yes">
    <title id="page-title">HHmobile.com</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fdf8f4;
            color: #333;
            transition: background-image 0.5s ease-in-out, background-color 0.5s ease-in-out;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        header {
            background-color: #FFD100;
            color: #333;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.7);
        }
        #shop-name-display {
            color: #333;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            transform: scale(0.9);
            transition: transform 0.3s ease-in-out;
            border-radius: 1.5rem;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        .price-original {
            text-decoration: line-through;
            color: #999;
        }
        .price-discounted {
            color: #e53e3e;
            font-weight: 600;
        }
        .order-status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin-bottom: 2rem;
        }
        .order-status-step {
            flex: 1;
            text-align: center;
            padding: 0.4rem 0;
            border-bottom: 3px solid #ccc;
            color: #999;
            font-weight: 500;
            position: relative;
            transition: all 0.3s ease-in-out;
        }
        .order-status-step.active {
            border-color: #4CAF50;
            color: #4CAF50;
        }
        .order-status-step::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid transparent;
            transition: all 0.3s ease-in-out;
        }
        .order-status-step.active::after {
            border-bottom-color: #4CAF50;
        }
        .tab-button.active {
            background-color: #4CAF50;
            color: white;
        }
        .option-button.selected {
            background-color: #d1e7dd;
            border-color: #28a745;
            color: #212529;
            position: relative;
        }
        .option-button.selected::after {
            content: "\f00c";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            position: absolute;
            top: 5px;
            right: 5px;
            color: #28a745;
            font-size: 0.8em;
        }
        .blurred-content {
            filter: blur(5px);
            transition: filter 0.2s ease-in-out;
        }
        .masked-input-wrapper {
            position: relative;
        }
        .masked-input-wrapper .toggle-visibility-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 0.5rem;
            padding: 0 0.75rem;
            display: flex;
            align-items: center;
            color: #6b7280;
            background: transparent;
            border: none;
            cursor: pointer;
        }
        .masked-input-wrapper textarea + .toggle-visibility-btn {
            top: 0.5rem;
            height: auto;
        }
        .out-of-stock {
            color: #ef4444;
            font-weight: 600;
        }
        .order-expandable-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .order-expandable-content.expanded {
            max-height: 500px;
            transition: max-height 0.5s ease-in;
        }
        .relative-container {
            position: relative;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            font-size: 1.5rem;
            color: #333;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes neon-glow {
            0%, 100% {
                text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #00f, 0 0 20px #00f, 0 0 25px #00f, 0 0 30px #00f, 0 0 35px #00f;
            }
            50% {
                text-shadow: 0 0 2px #fff, 0 0 5px #fff, 0 0 8px #00f, 0 0 12px #00f, 0 0 15px #00f, 0 0 20px #00f, 0 0 25px #00f;
            }
        }
        #shop-name-display.animated {
            animation: neon-glow 1.5s ease-in-out infinite alternate;
        }
        .advertisement-banner {
            background-color: #ffeb3b;
            color: #e53935;
            text-align: center;
            padding: 10px 0;
            font-weight: bold;
            font-size: 1.2rem;
            position: fixed;
            top: 48px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 45;
            overflow: hidden;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .advertisement-banner .content {
            display: inline-block;
            white-space: nowrap;
            animation: marquee 15s linear infinite;
        }
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        @keyframes flicker {
            0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% {
                opacity: 1;
                text-shadow: 0 0 4px #ff0, 0 0 10px #ff0, 0 0 20px #ff0, 0 0 40px #ff0;
            }
            20%, 24%, 55% {
                opacity: 0.5;
                text-shadow: none;
            }
        }
        .advertisement-banner.flicker .content {
            animation: flicker 2s infinite alternate, marquee 15s linear infinite;
        }
        .header-search-input {
            border-radius: 9999px;
            border: 1px solid #ccc;
            padding: 0.5rem 0.5rem 0.5rem 2.5rem;
            width: 300px;
            transition: width 0.3s ease-in-out;
        }
        .header-search-icon {
            position: absolute;
            left: 0.75rem;
            color: #6b7280;
        }
        @media (max-width: 768px) {
            .header-search-input {
                width: 100%;
            }
        }
        .star-rating .fa-star {
            color: gold;
        }
        .warranty-package-card {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background-color: #f8fafc;
            transition: all 0.2s ease-in-out;
        }
        .warranty-package-card.selected-package {
            border-color: #3b82f6;
            background-color: #eff6ff;
            box-shadow: 0 0 0 2px #bfdbfe;
        }
    </style>
</head>
<body class="bg-fdf8f4 text-333">

    <header class="fixed top-0 left-0 right-0 z-40 bg-yellow-400 text-gray-800 shadow-lg py-6 px-6 md:px-6 lg:px-16 w-full flex items-center justify-between h-12">
        <div class="flex items-center">
            <h1 id="shop-name-display" class="text-2xl lg:text-3xl font-bold rounded-full py-1 px-4 transition-all duration-300 ease-in-out hover:scale-105 cursor-pointer mr-4 lg:mr-6">
                <i class="fas fa-mobile-alt mr-2 text-gray-700"></i><span class="text-gray-900">Thegioididong</span><span class="text-red-600">.com</span>
            </h1>
            <div class="relative flex items-center w-48 md:w-64 lg:w-80">
                <input type="text" id="header-product-search-input" placeholder="Bạn tìm gì..." class="header-search-input focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                <i class="fas fa-search header-search-icon"></i>
            </div>
        </div>

        <div class="flex items-center space-x-4 lg:space-x-6">
            <div id="cart-section" class="flex items-center">
                <button id="open-cart-modal-btn" class="flex items-center text-gray-800 hover:text-gray-900 font-medium py-1 px-2 rounded-full transition-all duration-200 relative text-sm">
                    <i class="fas fa-shopping-cart text-lg mr-2"></i>
                    Giỏ hàng
                    <span id="cart-count" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
            </div>

            <div id="shop-address-container" class="flex items-center text-xs text-gray-800 text-right">
                <i class="fas fa-map-marker-alt text-base mr-1"></i>
                <div class="flex flex-col">
                    <span class="font-semibold mb-0.5">Địa chỉ cửa hàng:</span>
                    <span id="shop-address-display" class="text-xs italic text-gray-700">Chưa cập nhật</span>
                </div>
                <button id="open-address-in-map-btn" class="ml-2 bg-gray-200 hover:bg-gray-300 text-gray-800 text-xs py-1 px-2 rounded-full transition-all duration-200">
                    <i class="fas fa-external-link-alt mr-1"></i>
                </button>
            </div>
            <div id="auth-section">
                <button id="login-status-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 shadow-lg">Đăng nhập</button>
            </div>
        </div>
    </header>

    <div id="advertisement-banner-container" class="advertisement-banner hidden fixed top-15 left-190 right-0 z-30 mx-auto w-[95%] md:w-[85%] lg:w-[80%] xl:w-[70%] p-3 rounded-lg h-14">
        <div class="content" id="advertisement-content"></div>
    </div>


    <div class="flex flex-1 w-full pt-28">
        <aside class="fixed top-0 left-0 z-30 w-56 lg:w-64 h-full pt-20 bg-white p-4 rounded-xl shadow-lg overflow-y-auto border-r border-gray-200">
            <h2 class="text-xl font-semibold mb-6 text-gray-800">MENU</h2>
            <nav>
                <ul class="space-y-3">
                    <li><button id="show-products-btn" class="tab-button w-full text-left p-3 rounded-lg font-medium text-base transition-all duration-200 hover:bg-gray-100 active"><i class="fas fa-boxes mr-2"></i>Gian Hàng</button></li>
                    <li><button id="show-created-orders-btn" class="tab-button w-full text-left p-3 rounded-lg font-medium text-base transition-all duration-200 hover:bg-gray-100"><i class="fas fa-clipboard-list mr-2"></i>Đơn Hàng Đã Tạo</button></li>
                    <li><button id="show-shipping-orders-btn" class="tab-button w-full text-left p-3 rounded-lg font-medium text-base transition-all duration-200 hover:bg-gray-100"><i class="fas fa-truck mr-2"></i>Đơn Hàng Đang Vận Chuyển</button></li>
                    <li><button id="show-delivered-orders-btn" class="tab-button w-full text-left p-3 rounded-lg font-medium text-base transition-all duration-200 hover:bg-gray-100"><i class="fas fa-check-circle mr-2"></i>Đơn Hàng Đã Giao</button></li>
                    <li><button id="open-management-modal-btn" class="tab-button w-full text-left p-3 rounded-lg font-medium text-base transition-all duration-200 hover:bg-gray-100"><i class="fas fa-cogs mr-2"></i>Nhập Hàng</button></li>
                    <li><button id="open-settings-modal-btn" class="tab-button w-full text-left p-3 rounded-lg font-medium text-base transition-all duration-200 hover:bg-gray-100"><i class="fas fa-cog mr-2"></i>Cài Đặt</button></li>
                    <li><button id="open-shop-analytics-modal-btn" class="tab-button w-full text-left p-3 rounded-lg font-medium text-base transition-all duration-200 hover:bg-gray-100"><i class="fas fa-chart-line mr-2"></i>Thống Kê</button></li>
                    <li><button id="open-profile-modal-btn" class="tab-button w-full text-left p-3 rounded-lg font-medium text-base transition-all duration-200 hover:bg-gray-100"><i class="fas fa-user mr-2"></i>Hồ sơ</button></li>
                </ul>
            </nav>
        </aside>

        <section class="flex-1 ml-56 lg:ml-64 p-6 rounded-xl shadow-lg bg-white overflow-y-auto">
            <div id="product-list-section" class="active-section">
                <h2 class="text-3xl font-semibold mb-6 text-gray-800">Sản Phẩm Nổi Bật</h2>
                <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
            </div>

            <div id="created-orders-section" class="hidden">
                <h2 class="text-3xl font-semibold mb-6 text-gray-800">Đơn Hàng Đã Tạo</h2>
                <div class="mb-4 flex items-center gap-2">
                    <input type="text" id="search-created-orders" placeholder="Tìm kiếm đơn hàng đã tạo..." class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="clear-search-created-orders" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition-all duration-200"><i class="fas fa-times"></i></button>
                </div>
                <div id="created-orders-list" class="space-y-4">
                </div>
            </div>

            <div id="shipping-orders-section" class="hidden">
                <h2 class="text-3xl font-semibold mb-6 text-gray-800">Đơn Hàng Đang Vận Chuyển</h2>
                   <div class="mb-4 flex items-center gap-2">
                    <input type="text" id="search-shipping-orders" placeholder="Tìm kiếm đơn hàng đang vận chuyển..." class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="clear-search-shipping-orders" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition-all duration-200"><i class="fas fa-times"></i></button>
                </div>
                <div id="shipping-orders-list" class="space-y-4">
                </div>
            </div>

            <div id="delivered-orders-section" class="hidden">
                <h2 class="text-3xl font-semibold mb-6 text-gray-800">Đơn Hàng Đã Giao</h2>
                <div class="mb-4 flex items-center gap-2">
                    <input type="text" id="search-delivered-orders" placeholder="Tìm kiếm đơn hàng đã giao..." class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="clear-search-delivered-orders" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition-all duration-200"><i class="fas fa-times"></i></button>
                </div>
                <div id="delivered-orders-list" class="space-y-4">
                </div>
            </div>
        </section>
    </div>

    <div id="product-detail-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay p-4">
        <div class="bg-blue-50 rounded-3xl shadow-2xl p-8 max-w-4xl w-full flex flex-col md:flex-row gap-8 relative modal-content max-h-[85vh] overflow-y-auto">
            <button id="close-product-modal" class="absolute top-4 right-4 text-gray-600 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <div class="md:w-1/2 flex items-center justify-center p-4">
                <img id="modal-product-image" src="" alt="Sản phẩm" class="max-h-96 w-auto object-contain mb-4 rounded-lg shadow-md">
            </div>
            <div class="md:w-1/2">
                <h3 id="modal-product-name" class="text-3xl font-bold mb-4 text-gray-900"></h3>
                <p class="text-xl font-semibold mb-2 text-gray-700">Giá gốc: <span id="modal-product-base-price" class="font-bold"></span></p>
                <p class="text-xl font-semibold mb-2 text-gray-700">Tổng giá (chưa VAT): <span id="modal-product-price-display" class="price-original"></span></p>
                <p class="text-xs font-semibold mb-2 text-gray-700">VAT (10% theo quy định nhà nước): <span id="modal-product-vat-display" class="font-bold text-red-600"></span></p>
                <p id="modal-product-discount-display" class="text-xl font-semibold mb-4 price-discounted hidden"></p>

                <div id="product-options" class="mb-6 space-y-4">
                </div>

                <p class="text-gray-600 mb-2">Số lượng đã bán: <span id="modal-product-sold">N/A</span></p>
                <p class="text-gray-600 mb-4">Số lượng còn lại: <span id="modal-product-remaining">N/A</span></p>
                <p id="modal-product-description" class="text-gray-700 mb-4 text-sm"></p>

                <div class="mb-4 text-gray-700 text-sm">
                    <p class="mb-1"><i class="fas fa-undo-alt mr-2 text-blue-500"></i> Chính sách đổi trả: <span class="font-semibold">15 Ngày</span></p>
                    <p id="modal-shipping-cost-display"><i class="fas fa-shipping-fast mr-2 text-green-500"></i> Phí vận chuyển: <span class="font-semibold">Thanh toán khi đặt hàng (50,000đ)</span></p>
                </div>

                <div class="mb-6">
                    <label for="voucher-code" class="block text-gray-700 text-sm font-bold mb-2">Mã Voucher:</label>
                    <div class="flex">
                        <input type="text" id="voucher-code" class="shadow appearance-none border rounded-l-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập mã voucher">
                        <button id="apply-voucher-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-r-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200"><i class="fas fa-ticket-alt"></i> Áp Dụng</button>
                    </div>
                </div>

                <div class="flex gap-4 mt-6">
                    <button id="buy-now-detail-btn" class="bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-bold py-3 px-6 rounded-lg flex-1 transition-all duration-200 shadow-lg"><i class="fas fa-dollar-sign mr-2"></i>Mua Ngay</button>
                    <button id="add-to-cart-detail-btn" class="bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-bold py-3 px-6 rounded-lg flex-1 transition-all duration-200 shadow-lg"><i class="fas fa-cart-plus mr-2"></i>Thêm vào giỏ hàng</button>
                </div>
            </div>
        </div>
    </div>

    <div id="order-creation-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay p-4">
        <div class="bg-blue-50 rounded-3xl shadow-2xl p-8 max-w-2xl w-full relative modal-content max-h-[85vh] overflow-y-auto">
            <button id="close-order-modal" class="absolute top-4 right-4 text-gray-600 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <h3 class="text-3xl font-bold mb-6 text-gray-900 text-center">Tạo Đơn Hàng Mới</h3>

            <div class="mb-6">
                <p class="text-gray-700 text-lg mb-2">Mã đơn hàng: <span id="order-id-display" class="font-semibold text-blue-700"></span></p>
                <div id="order-products-summary" class="border p-4 rounded-lg bg-gray-50 max-h-40 overflow-y-auto">
                </div>
            </div>

            <form id="order-form" class="space-y-4">
                <div>
                    <label for="customer-name" class="block text-gray-700 text-lg font-bold mb-2">Họ tên:</label>
                    <input type="text" id="customer-name" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="customer-phone" class="block text-gray-700 text-lg font-bold mb-2">Số điện thoại:</label>
                    <div class="masked-input-wrapper">
                        <input type="tel" id="customer-phone" class="shadow appearance-none border rounded-lg w-full py-3 px-4 pr-12 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <button type="button" class="toggle-visibility-btn" data-target-id="customer-phone">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="customer-address" class="block text-gray-700 text-lg font-bold mb-2">Địa chỉ:</label>
                    <div class="masked-input-wrapper">
                        <textarea id="customer-address" class="shadow appearance-none border rounded-lg w-full py-3 px-4 pr-12 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 h-24 resize-none" required></textarea>
                        <button type="button" class="toggle-visibility-btn" data-target-id="customer-address">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div>
                    <label for="order-location" class="block text-gray-700 text-lg font-bold mb-2">Vị trí kho hàng:</label>
                    <input type="text" id="order-location" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Chi nhánh kho">
                </div>
                <div>
                    <label for="estimated-delivery-date" class="block text-gray-700 text-lg font-bold mb-2">Ngày dự kiến nhận hàng:</label>
                    <input type="date" id="estimated-delivery-date" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <button id="view-on-map-btn" type="button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg w-full transition-all duration-200 shadow-lg">
                    <i class="fas fa-map-marked-alt mr-2"></i>Xem trên Bản Đồ
                </button>

                <div class="order-status-bar">
                    <div class="order-status-step active" data-status="created">Tạo Đơn Hàng</div>
                    <div class="order-status-step" data-status="shipping">Đang Vận Chuyển</div>
                    <div class="order-status-step" data-status="delivered">Đã Giao Hàng</div>
                </div>

                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg w-full transition-all duration-200 shadow-lg"><i class="fas fa-check-square mr-2"></i>Xác Nhận Đơn Hàng</button>
            </form>
        </div>
    </div>

    <div id="edit-shipping-order-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay p-4">
        <div class="bg-blue-50 rounded-3xl shadow-2xl p-8 max-w-xl w-full relative modal-content max-h-[85vh] overflow-y-auto">
            <button id="close-edit-shipping-modal" class="absolute top-4 right-4 text-gray-600 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <h3 class="text-3xl font-bold mb-6 text-gray-900 text-center">Chỉnh Sửa Thông Tin Vận Chuyển</h3>
            <p class="text-gray-700 text-lg mb-4">Đơn hàng: <span id="edit-shipping-order-id-display" class="font-semibold text-blue-700"></span></p>

            <form id="edit-shipping-order-form" class="space-y-4">
                <input type="hidden" id="edit-shipping-order-hidden-id">
                <div>
                    <label for="edit-order-location" class="block text-gray-700 text-lg font-bold mb-2">Vị trí hiện tại:</label>
                    <input type="text" id="edit-order-location" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ví dụ: Đang ở kho Hồ Chí Minh">
                </div>
                <div>
                    <label for="edit-estimated-delivery-date" class="block text-gray-700 text-lg font-bold mb-2">Ngày dự kiến nhận hàng:</label>
                    <input type="date" id="edit-estimated-delivery-date" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg w-full transition-all duration-200 shadow-lg"><i class="fas fa-save mr-2"></i>Lưu Thay Đổi</button>
            </form>
        </div>
    </div>

    <div id="cart-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay p-4">
        <div class="bg-blue-50 rounded-3xl shadow-2xl p-8 max-w-3xl w-full relative modal-content max-h-[85vh] overflow-y-auto">
            <button id="close-cart-modal" class="absolute top-4 right-4 text-gray-600 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <h3 class="text-3xl font-bold mb-6 text-gray-900 text-center">Giỏ Hàng Của Bạn</h3>

            <div class="mb-4 flex items-center gap-2">
                <input type="text" id="search-cart-items" placeholder="Tìm kiếm sản phẩm trong giỏ hàng..." class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="clear-search-cart-items" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition-all duration-200"><i class="fas fa-times"></i></button>
            </div>

            <div id="cart-items-list" class="space-y-4 mb-6">
                <p class="text-gray-500 italic text-center">Giỏ hàng trống.</p>
            </div>

            <div class="flex justify-between items-center border-t pt-4 border-gray-200">
                <span class="text-xl font-bold text-gray-900">Tổng cộng: <span id="cart-total-amount">0 VND</span></span>
                <button id="buy-all-cart-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 shadow-lg"><i class="fas fa-credit-card mr-2"></i>Mua Ngay Tất Cả</button>
            </div>
        </div>
    </div>


    <div id="shop-management-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay p-4">
        <div class="bg-blue-50 rounded-3xl shadow-2xl p-8 max-w-4xl w-full relative overflow-y-auto max-h-[90vh] modal-content">
            <button id="close-management-modal" class="absolute top-4 right-4 text-gray-600 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <h3 class="text-3xl font-bold mb-6 text-gray-900 text-center">Cửa Hàng</h3>

            <div id="management-content-area" class="relative-container rounded-3xl p-4">
                <div class="mb-8 border-b pb-6 border-gray-200">
                    <h4 class="text-2xl font-semibold mb-4 text-gray-800">Quản lý Sản phẩm Hiện Có</h4>
                    <div id="product-management-list" class="space-y-4">
                        <p class="text-gray-500 italic">Đang tải danh sách sản phẩm...</p>
                    </div>
                </div>


                <div class="mb-8 border-b pb-6 border-gray-200">
                    <h4 id="add-edit-product-title" class="text-2xl font-semibold mb-4 text-gray-800">Thêm Mặt Hàng Mới</h4>
                    <form id="add-edit-product-form" class="space-y-4">
                        <input type="hidden" id="edit-product-id">
                        <div>
                            <label for="new-product-name" class="block text-gray-700 text-lg font-bold mb-2">Tên Sản Phẩm:</label>
                            <input type="text" id="new-product-name" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="new-product-base-price" class="block text-gray-700 text-lg font-bold mb-2">Giá gốc (VND):</label>
                            <input type="number" id="new-product-base-price" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required min="0">
                        </div>

                        <div>
                            <label for="new-product-image" class="block text-gray-700 text-lg font-bold mb-2">URL Hình Ảnh Chính (URL trực tiếp, bao gồm GitHub Raw hoặc Base64):</label>
                            <div class="flex gap-2">
                                <input type="url" id="new-product-image" class="shadow appearance-none border rounded-l-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://example.com/image.jpg hoặc chuỗi Base64 dài">
                                <button type="button" id="upload-main-image-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-r-lg transition-all duration-200 text-sm flex-shrink-0"><i class="fas fa-upload mr-2"></i>Tải ảnh lên</button>
                            </div>
                        </div>
                        <div>
                            <label for="new-product-description" class="block text-gray-700 text-lg font-bold mb-2">Mô tả sản phẩm:</label>
                            <textarea id="new-product-description" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 h-20 resize-none"></textarea>
                        </div>
                        <div>
                            <label for="new-product-reviews" class="block text-gray-700 text-lg font-bold mb-2">Lượt Đánh Giá (Số lượng):</label>
                            <input type="number" id="new-product-reviews" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" value="0" min="0">
                        </div>

                        <div class="border p-4 rounded-lg bg-gray-50">
                            <h5 class="text-xl font-semibold mb-3 text-gray-700">Tùy Chọn Màu Sắc (kèm Giá tác động)</h5>
                            <div id="color-options-container" class="space-y-3">
                            </div>
                            <button type="button" id="add-color-option-btn" class="mt-4 bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200"><i class="fas fa-plus mr-2"></i>Thêm Màu Sắc</button>
                        </div>

                        <div class="border p-4 rounded-lg bg-gray-50">
                            <h5 class="text-xl font-semibold mb-3 text-gray-700">Tùy Chọn Dung Lượng (kèm Giá tác động)</h5>
                            <div id="storage-options-container" class="space-y-3">
                            </div>
                            <button type="button" id="add-storage-option-btn" class="mt-4 bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200"><i class="fas fa-plus mr-2"></i>Thêm Dung Lượng</button>
                        </div>

                        <div class="border p-4 rounded-lg bg-yellow-50">
                            <h5 class="text-xl font-semibold mb-3 text-gray-700">Các Biến Thể Sản Phẩm (Màu sắc + Dung lượng, kèm số lượng & Giá tác động riêng)</h5>
                            <div id="variants-container" class="space-y-3">
                            </div>
                            <button type="button" id="add-variant-btn" class="mt-4 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200"><i class="fas fa-plus mr-2"></i>Thêm Biến Thể</button>
                            <p class="text-sm text-gray-600 mt-2">Lưu ý: Chỉ thêm biến thể sau khi đã định nghĩa các Tùy chọn Màu sắc và Dung lượng phía trên.</p>
                        </div>

                        <button type="submit" id="submit-product-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg w-full transition-all duration-200 shadow-lg mt-6"><i class="fas fa-save mr-2"></i>Thêm Sản Phẩm</button>
                        <button type="button" id="cancel-edit-btn" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg w-full transition-all duration-200 shadow-lg mt-2"><i class="fas fa-times-circle mr-2"></i>Hủy Chỉnh Sửa</button>
                    </form>
                </div>

                <div class="mt-8 border-b pb-6 border-gray-200">
                    <h4 class="text-2xl font-semibold mb-4 text-gray-800">Thêm Mã Voucher Mới</h4>
                    <form id="add-voucher-form" class="space-y-4">
                        <div>
                            <label for="new-voucher-code" class="block text-gray-700 text-lg font-bold mb-2">Mã Voucher:</label>
                            <input type="text" id="new-voucher-code" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="new-voucher-value" class="block text-gray-700 text-lg font-bold mb-2">Giá Trị Voucher (ví dụ: 0.10 cho 10%, 50000 cho 50.000 VND):</label>
                            <input type="number" step="any" id="new-voucher-value" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required min="0">
                        </div>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg w-full transition-all duration-200 shadow-lg"><i class="fas fa-plus-square mr-2"></i>Thêm Voucher</button>
                    </form>

                    <div class="mt-8">
                        <h4 class="text-2xl font-semibold mb-4 text-gray-800">Voucher Hiện Có</h4>
                        <div id="current-vouchers-list" class="space-y-2">
                            <p class="text-gray-500 italic">Chưa có voucher nào.</p>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <h4 class="text-2xl font-semibold mb-4 text-gray-800">Quản lý Gói Bảo Hành</h4>
                    <form id="add-edit-warranty-package-form" class="space-y-4">
                        <input type="hidden" id="edit-warranty-package-id">
                        <div>
                            <label for="new-warranty-package-name" class="block text-gray-700 text-lg font-bold mb-2">Tên Gói Bảo Hành:</label>
                            <input type="text" id="new-warranty-package-name" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label for="new-warranty-package-price" class="block text-gray-700 text-lg font-bold mb-2">Giá (VND):</label>
                            <input type="number" id="new-warranty-package-price" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required min="0">
                        </div>
                        <div>
                            <label for="new-warranty-package-discount" class="block text-gray-700 text-lg font-bold mb-2">Giảm Giá (%):</label>
                            <input type="number" id="new-warranty-package-discount" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" value="0" min="0" max="100">
                        </div>
                        <button type="submit" id="submit-warranty-package-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg w-full transition-all duration-200 shadow-lg"><i class="fas fa-plus-square mr-2"></i>Thêm Gói Bảo Hành</button>
                        <button type="button" id="cancel-edit-warranty-package-btn" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg w-full transition-all duration-200 shadow-lg mt-2"><i class="fas fa-times-circle mr-2"></i>Hủy Chỉnh Sửa</button>
                    </form>

                    <div class="mt-8">
                        <h4 class="text-2xl font-semibold mb-4 text-gray-800">Các Gói Bảo Hành Hiện Có</h4>
                        <div id="current-warranty-packages-list" class="space-y-2">
                            <p class="text-gray-500 italic">Chưa có gói bảo hành nào.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="shop-settings-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay p-4">
        <div class="bg-blue-50 rounded-3xl shadow-2xl p-8 max-w-xl w-full relative modal-content max-h-[85vh] overflow-y-auto">
            <button id="close-settings-modal" class="absolute top-4 right-4 text-gray-600 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <h3 class="text-3xl font-bold mb-6 text-gray-900 text-center">Cài Đặt Cửa Hàng</h3>

            <div id="settings-content-area" class="relative-container rounded-3xl p-4">
                <form id="shop-settings-form" class="space-y-4">
                    <div>
                        <label for="shop-name-input" class="block text-gray-700 text-lg font-bold mb-2">Tên Cửa Hàng:</label>
                        <input type="text" id="shop-name-input" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="shop-address-input" class="block text-gray-700 text-lg font-bold mb-2">Địa chỉ Cửa Hàng:</label>
                        <input type="text" id="shop-address-input" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập địa chỉ cửa hàng của bạn">
                    </div>
                    <div>
                        <label for="background-image-url" class="block text-gray-700 text-lg font-bold mb-2">URL Hình Nền:</label>
                        <div class="flex gap-2">
                            <input type="url" id="background-image-url" class="shadow appearance-none border rounded-l-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://example.com/image.jpg">
                                <button type="button" id="upload-background-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-r-lg transition-all duration-200 text-sm flex-shrink-0"><i class="fas fa-upload mr-2"></i>Tải ảnh lên</button>
                            </div>
                        <small class="text-gray-500">Để trống nếu không muốn dùng hình nền.</small>
                    </div>
                    <div>
                        <label for="advertisement-text-input" class="block text-gray-700 text-lg font-bold mb-2">Nội dung quảng cáo:</label>
                        <input type="text" id="advertisement-text-input" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ví dụ: Giảm giá 50% tất cả sản phẩm!">
                        <small class="text-gray-500">Để trống để ẩn banner quảng cáo.</small>
                    </div>
                    <div>
                        <label for="advertisement-animation-select" class="block text-gray-700 text-lg font-bold mb-2">Hiệu ứng quảng cáo:</label>
                        <select id="advertisement-animation-select" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="none">Không có</option>
                            <option value="marquee">Chữ chạy</option>
                            <option value="flicker">Nhấp nháy</option>
                        </select>
                    </div>

                    <div class="border p-4 rounded-lg bg-gray-50 space-y-4">
                        <h4 class="text-xl font-semibold mb-3 text-gray-700">Cài đặt Thanh toán QR Code Ngân hàng</h4>
                        <div>
                            <label for="bank-name-input" class="block text-gray-700 text-lg font-bold mb-2">Tên Ngân hàng:</label>
                            <input type="text" id="bank-name-input" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ví dụ: Vietcombank">
                        </div>
                        <div>
                            <label for="account-number-input" class="block text-gray-700 text-lg font-bold mb-2">Số Tài khoản:</label>
                            <input type="text" id="account-number-input" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ví dụ: 0123456789">
                        </div>
                        <div>
                            <label for="account-holder-input" class="block text-gray-700 text-lg font-bold mb-2">Tên Chủ tài khoản:</label>
                            <input type="text" id="account-holder-input" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ví dụ: NGUYEN VAN A">
                        </div>
                        <div>
                            <label for="qr-code-image-url-input" class="block text-gray-700 text-lg font-bold mb-2">URL Ảnh QR Code Ngân hàng:</label>
                            <div class="flex gap-2">
                                <input type="url" id="qr-code-image-url-input" class="shadow appearance-none border rounded-l-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://example.com/qr_code.png">
                                <button type="button" id="upload-qr-code-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-r-lg transition-all duration-200 text-sm flex-shrink-0"><i class="fas fa-upload mr-2"></i>Tải ảnh lên</button>
                            </div>
                            <small class="text-gray-500">Đây là ảnh QR Code mà khách hàng sẽ quét để thanh toán.</small>
                        </div>
                    </div>

                    <div class="border p-4 rounded-lg bg-gray-50 space-y-4">
                        <h4 class="text-xl font-semibold mb-3 text-gray-700">Cài đặt Đơn vị Vận chuyển</h4>
                        <div>
                            <label for="shipping-unit-name-input" class="block text-gray-700 text-lg font-bold mb-2">Tên Đơn vị Vận chuyển (mặc định GHN Express):</label>
                            <input type="text" id="shipping-unit-name-input" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ví dụ: GHN Express, GHTK" value="GHN Express">
                        </div>
                        <div>
                            <label for="shipping-unit-image-url-input" class="block text-gray-700 text-lg font-bold mb-2">URL Ảnh Đơn vị Vận chuyển:</label>
                            <div class="flex gap-2">
                                <input type="url" id="shipping-unit-image-url-input" class="shadow appearance-none border rounded-l-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://example.com/shipping_logo.png">
                                <button type="button" id="upload-shipping-unit-image-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-r-lg transition-all duration-200 text-sm flex-shrink-0"><i class="fas fa-upload mr-2"></i>Tải ảnh lên</button>
                            </div>
                            <small class="text-gray-500">Ảnh logo của đơn vị vận chuyển.</small>
                        </div>
                    </div>

                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg w-full transition-all duration-200 shadow-lg"><i class="fas fa-save mr-2"></i>Lưu Cài Đặt</button>
                </form>
            </div>
        </div>
    </div>

    <div id="shop-analytics-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay p-4">
        <div class="bg-blue-50 rounded-3xl shadow-2xl p-8 max-w-3xl w-full relative modal-content max-h-[85vh] overflow-y-auto">
            <button id="close-analytics-modal" class="absolute top-4 right-4 text-gray-600 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <h3 class="text-3xl font-bold mb-6 text-gray-900 text-center">Thống Kê Cửa Hàng</h3>

            <div id="analytics-content-area" class="relative-container rounded-3xl p-4">
                <div class="mb-6 flex flex-col md:flex-row items-center gap-4">
                    <div class="flex-1 w-full">
                        <label for="report-start-date" class="block text-gray-700 text-sm font-bold mb-2">Từ ngày:</label>
                        <input type="date" id="report-start-date" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex-1 w-full">
                        <label for="report-end-date" class="block text-gray-700 text-sm font-bold mb-2">Đến ngày:</label>
                        <input type="date" id="report-end-date" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button id="generate-report-btn" class="mt-6 md:mt-0 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 flex-shrink-0"><i class="fas fa-chart-bar mr-2"></i>Tạo Báo Cáo</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-xl font-semibold text-gray-800 mb-4">Tổng Doanh Thu</h4>
                        <p id="total-revenue-display" class="text-3xl font-bold text-green-600">0 VND</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h4 class="text-xl font-semibold text-gray-800 mb-4">Số Lượng Đơn Hàng</h4>
                        <p id="total-orders-display" class="text-3xl font-bold text-purple-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md col-span-1 md:col-span-2">
                        <h4 class="text-xl font-semibold text-gray-800 mb-4">Sản Phẩm Bán Chạy Nhất</h4>
                        <ul id="top-selling-products-list" class="list-disc pl-5 text-gray-700">
                            <li class="italic text-gray-500">Chưa có dữ liệu.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="payment-vat-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay p-4">
        <div class="bg-blue-50 rounded-3xl shadow-2xl p-8 max-w-lg w-full relative modal-content max-h-[85vh] overflow-y-auto">
            <button id="close-payment-vat-modal" class="absolute top-4 right-4 text-gray-600 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <h3 class="text-2xl font-bold mb-6 text-gray-900 text-center">Thuế Giá Trị Gia Tăng (VAT)</h3>

            <div id="qr-payment-details" class="flex flex-col items-center mb-6">
                <img id="qr-code-display" src="" onerror="this.onerror=null;this.src='https://placehold.co/200x200/cccccc/333333?text=QR+Code';" alt="Mã QR Ngân hàng" class="w-48 h-48 object-contain rounded-lg mb-4 shadow-md">
                <p class="text-gray-700 text-lg font-semibold"><i class="fas fa-university mr-2 text-blue-600"></i>Ngân hàng: <span id="bank-name-display" class="font-bold"></span></p>
                <p class="text-gray-700 text-lg font-semibold"><i class="fas fa-credit-card mr-2 text-green-600"></i>Số tài khoản: <span id="account-number-display" class="font-bold"></span></p>
                <p class="text-gray-700 text-lg font-semibold mb-4"><i class="fas fa-user-circle mr-2 text-purple-600"></i>Chủ tài khoản: <span id="account-holder-display" class="font-bold"></span></p>
                <p class="text-gray-700 text-xl font-bold">Giá đơn hàng (chưa VAT): <span id="vat-base-amount" class="text-blue-700">0 VND</span></p>
                <p class="text-gray-700 text-xl font-bold">Tổng tiền VAT khách hàng thanh toán (2%): <span id="payment-modal-vat-total" class="text-blue-700">0 VND</span></p>
            </div>

            <div class="mb-4">
                <label for="payment-amount-input" class="block text-gray-700 text-lg font-bold mb-2">Phí VAT khách hàng cần thanh cho đơn hàng:</label>
                <input type="text" id="payment-amount-input" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Phí VAT">
            </div>

            <div class="mb-6 bg-gray-100 p-4 rounded-lg">
                <p class="text-gray-700 text-lg font-semibold">Thanh toán khi nhận hàng: <span id="amount-paid-display" class="font-bold text-green-600">0 VND</span></p>
                <p class="text-gray-700 text-lg font-semibold">Khách hàng thanh toán (2%): <span id="remaining-payment-display" class="font-bold text-red-600">0 VND</span></p>
            </div>

            <button id="confirm-payment-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg w-full transition-all duration-200 shadow-lg"><i class="fas fa-check-circle mr-2"></i>Thanh Toán</button>
            <button id="admin-confirm-vat-payment-btn" class="hidden mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg w-full transition-all duration-200 shadow-lg"><i class="fas fa-check-circle mr-2"></i>Admin Xác Nhận</button>
        </div>
    </div>

    <div id="order-tracking-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay p-4">
        <div class="bg-blue-50 rounded-3xl shadow-2xl p-8 max-w-xl w-full relative modal-content max-h-[85vh] overflow-y-auto">
            <button id="close-order-tracking-modal" class="absolute top-4 right-4 text-gray-600 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <h3 class="text-3xl font-bold mb-6 text-gray-900 text-center">Theo Dõi Đơn Hàng</h3>

            <div class="flex flex-col items-center mb-6">
                <img id="tracking-shipping-unit-image" src="" onerror="this.onerror=null;this.src='https://placehold.co/200x100/cccccc/333333?text=Shipping+Unit';" alt="Đơn vị vận chuyển" class="w-48 h-24 object-contain mb-4 rounded-lg shadow-sm">
                <p class="text-gray-700 text-lg font-semibold"><i class="fas fa-truck mr-2 text-blue-600"></i>Đơn vị vận chuyển: <span id="tracking-shipping-unit-name" class="font-bold">GHN Express</span></p>
            </div>

            <p class="text-gray-700 text-lg mb-4">Mã đơn hàng: <span id="tracking-order-id" class="font-semibold text-blue-700"></span></p>

            <div class="mb-4">
                <p class="text-gray-700 text-lg font-semibold">Sản phẩm:</p>
                <div id="tracking-product-details" class="border p-3 rounded-lg bg-gray-100">
                </div>
            </div>

            <div class="mb-4">
                <p class="text-gray-700 text-lg font-semibold">Địa chỉ hiện tại:</p>
                <p id="tracking-current-location" class="text-gray-800 ml-4"></p>
            </div>

            <div class="mb-6">
                <p class="text-gray-700 text-lg font-semibold">Điểm đến:</p>
                <p id="tracking-destination" class="text-gray-800 ml-4"></p>
            </div>

            <button id="check-route-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg w-full transition-all duration-200 shadow-lg">
                <i class="fas fa-route mr-2"></i>Theo dõi trực tuyến
            </button>
        </div>
    </div>

    <div id="payment-warranty-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 modal-overlay p-4">
        <div class="bg-blue-50 rounded-3xl shadow-2xl p-8 max-w-lg w-full relative modal-content max-h-[85vh] overflow-y-auto">
            <button id="close-payment-warranty-modal" class="absolute top-4 right-4 text-gray-600 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <h3 class="text-2xl font-bold mb-6 text-gray-900 text-center">Chọn Gói Bảo Hành</h3>

            <div id="warranty-packages-selection" class="space-y-3 mb-6">
            </div>

            <div id="qr-payment-details-warranty" class="flex flex-col items-center mb-6 border-t pt-6 border-gray-200">
                <img id="qr-code-display-warranty" src="" onerror="this.onerror=null;this.src='https://placehold.co/200x200/cccccc/333333?text=QR+Code';" alt="Mã QR Ngân hàng" class="w-48 h-48 object-contain rounded-lg mb-4 shadow-md">
                <p class="text-gray-700 text-lg font-semibold"><i class="fas fa-university mr-2 text-blue-600"></i>Ngân hàng: <span id="bank-name-display-warranty" class="font-bold"></span></p>
                <p class="text-gray-700 text-lg font-semibold"><i class="fas fa-credit-card mr-2 text-green-600"></i>Số tài khoản: <span id="account-number-display-warranty" class="font-bold"></span></p>
                <p class="text-gray-700 text-lg font-semibold mb-4"><i class="fas fa-user-circle mr-2 text-purple-600"></i>Chủ tài khoản: <span id="account-holder-display-warranty" class="font-bold"></span></p>
                <p class="text-gray-700 text-xl font-bold">Tổng tiền cần thanh toán: <span id="warranty-payment-total" class="text-blue-700">0 VND</span></p>
            </div>

            <button id="confirm-warranty-payment-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg w-full transition-all duration-200 shadow-lg"><i class="fas fa-check-circle mr-2"></i>Xác Nhận Thanh Toán</button>
            <button id="admin-confirm-warranty-btn" class="hidden mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg w-full transition-all duration-200 shadow-lg"><i class="fas fa-check-circle mr-2"></i>Admin Xác Nhận</button>
        </div>
    </div>

    <div id="login-register-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center relative modal-content">
            <button id="close-login-register-modal" class="absolute top-4 right-4 text-gray-600 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <h3 id="auth-modal-title" class="text-2xl font-bold text-gray-800 mb-6">Đăng nhập</h3>

            <div id="login-form">
                <div class="mb-4 text-left">
                    <label for="login-username" class="block text-gray-700 text-sm font-semibold mb-2">Tên đăng nhập (Email)</label>
                    <input type="email" id="login-username" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 text-gray-900">
                </div>
                <div class="mb-6 text-left">
                    <label for="login-password" class="block text-gray-700 text-sm font-semibold mb-2">Mật khẩu</label>
                    <input type="password" id="login-password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 text-gray-900">
                </div>
                <p id="login-error-message" class="text-red-500 text-sm mb-4 hidden"></p>
                <button id="login-submit-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105 active:scale-95">
                    Đăng nhập
                </button>
                <p class="mt-4 text-gray-600">Chưa có tài khoản? <a href="#" id="show-register-form-link" class="text-blue-600 hover:underline">Đăng ký ngay</a></p>
            </div>

            <div id="register-form" class="hidden max-h-[70vh] overflow-y-auto">
                <div class="mb-4 text-left">
                    <label for="register-username" class="block text-gray-700 text-sm font-semibold mb-2">Tên đăng nhập (Email)</label>
                    <input type="email" id="register-username" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 text-gray-900">
                </div>
                <div class="mb-4 text-left">
                    <label for="register-password" class="block text-gray-700 text-sm font-semibold mb-2">Mật khẩu</label>
                    <input type="password" id="register-password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 text-gray-900">
                </div>
                <div class="mb-4 text-left">
                    <label for="register-confirm-password" class="block text-gray-700 text-sm font-semibold mb-2">Xác nhận lại mật khẩu</label>
                    <input type="password" id="register-confirm-password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 text-gray-900">
                </div>
                <div class="mb-4 text-left">
                    <label for="register-fullname" class="block text-gray-700 text-sm font-semibold mb-2">Họ và tên</label>
                    <input type="text" id="register-fullname" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 text-gray-900">
                </div>
                <div class="mb-4 text-left">
                    <label for="register-phone" class="block text-gray-700 text-sm font-semibold mb-2">Số điện thoại</label>
                    <input type="tel" id="register-phone" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 text-gray-900">
                </div>
                <div class="mb-6 text-left">
                    <label for="register-province" class="block text-gray-700 text-sm font-semibold mb-2">Địa chỉ</label>
                    <input type="text" id="register-province" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 text-gray-900">
                </div>
                <p id="register-error-message" class="text-red-500 text-sm mb-4 hidden"></p>
                <button id="register-submit-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105 active:scale-95">
                    Đăng ký
                </button>
                <p class="mt-4 text-gray-600">Đã có tài khoản? <a href="#" id="show-login-form-link" class="text-blue-600 hover:underline">Đăng nhập</a></p>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center relative modal-content max-h-[80vh] overflow-y-auto">
            <button id="close-profile-modal" class="absolute top-4 right-4 text-gray-600 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Hồ sơ của bạn</h3>
            <div class="mb-4 text-left">
                <label for="profile-username" class="block text-gray-700 text-sm font-semibold mb-2">Tên đăng nhập (Email)</label>
                <input type="text" id="profile-username" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed text-gray-900" readonly>
            </div>
            <div class="mb-4 text-left">
                <label for="profile-fullname" class="block text-gray-700 text-sm font-semibold mb-2">Họ và tên</label>
                <input type="text" id="profile-fullname" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 text-gray-900">
            </div>
            <div class="mb-4 text-left">
                <label for="profile-phone" class="block text-gray-700 text-sm font-semibold mb-2">Số điện thoại</label>
                <input type="tel" id="profile-phone" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 text-gray-900">
            </div>
            <div class="mb-6 text-left">
                <label for="profile-province" class="block text-gray-700 text-sm font-semibold mb-2">Địa chỉ</label>
                <input type="text" id="profile-province" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200 text-gray-900">
            </div>
            <p id="profile-error-message" class="text-red-500 text-sm mb-4 hidden"></p>
            <button id="save-profile-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105 active:scale-95">
                Lưu thay đổi
            </button>
            <button id="close-profile-modal-btn" class="mt-4 w-full bg-gray-400 hover:bg-gray-500 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105 active:scale-95">
                Đóng
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        // __app_id: The unique ID for the current application instance.
        // __firebase_config: Firebase configuration object (JSON string) for initializing the app.
        // __initial_auth_token: Custom Firebase authentication token for initial sign-in.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // User's provided Firebase configuration for local testing
            apiKey: "AIzaSyBPjpG1V3HpR4wCFEXth1byWN0q9-9jWiM",
            authDomain: "hhmobile-df259.firebaseapp.com",
            projectId: "hhmobile-df259",
            storageBucket: "hhmobile-df259.firebaseapp.com",
            messagingSenderId: "273294651647",
            appId: "1:273294651647:web:02bcd7be6f760cd6849cca",
            measurementId: "G-YSJ062B717"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let loggedInUser = null;
        let currentUserId = null;
        const ADMIN_EMAIL = 'dimensiongsv@gmail.com'; // Ensure this matches your admin email
        const DEFAULT_WAREHOUSE_ADDRESS = "194 Đ. Lê Duẩn, Khâm Thiên, Đống Đa, Hà Nội";

        let shopDataCache = {
            products: [],
            vouchers: {},
            warrantyPackages: [],
            bankDetails: {},
            advertisement: {},
            shippingUnit: {},
            name: 'Thegioididong.com',
            address: 'Chưa cập nhật',
            backgroundImg: ''
        };
        let userOrdersCache = [];
        let userCartCache = [];

        const loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'loadingIndicator';
        loadingOverlay.className = 'loading-overlay hidden';
        loadingOverlay.innerHTML = '<div class="loading-spinner"></div>';
        document.body.appendChild(loadingOverlay);

        const messageDisplay = document.createElement('div');
        messageDisplay.id = 'messageDisplay';
        messageDisplay.className = 'message hidden fixed top-24 right-6 p-4 rounded-lg shadow-lg z-50';
        document.body.appendChild(messageDisplay);

        function showLoading() { loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { loadingOverlay.classList.add('hidden'); }
        function showMessage(message, type = 'info') {
            messageDisplay.textContent = message;
            messageDisplay.className = `message ${type} fixed top-24 right-6 p-4 rounded-lg shadow-lg z-50`;
            messageDisplay.classList.remove('hidden');
            setTimeout(() => {
                messageDisplay.classList.add('hidden');
                messageDisplay.textContent = '';
                messageDisplay.className = 'message hidden fixed top-24 right-6 p-4 rounded-lg shadow-lg z-50';
            }, 3000);
        }

        const shopNameDisplay = document.getElementById('shop-name-display');
        const shopAddressDisplay = document.getElementById('shop-address-display');
        const pageTitle = document.getElementById('page-title');
        const bodyElement = document.body;
        const advertisementBannerContainer = document.getElementById('advertisement-banner-container');
        const advertisementContent = document.getElementById('advertisement-content');
        const headerProductSearchInput = document.getElementById('header-product-search-input');

        const productDetailModal = document.getElementById('product-detail-modal');
        const orderCreationModal = document.getElementById('order-creation-modal');
        const editShippingOrderModal = document.getElementById('edit-shipping-order-modal');
        const shopManagementModal = document.getElementById('shop-management-modal');
        const shopSettingsModal = document.getElementById('shop-settings-modal');
        const shopAnalyticsModal = document.getElementById('shop-analytics-modal');
        const cartModal = document.getElementById('cart-modal');
        const paymentVATModal = document.getElementById('payment-vat-modal');
        const orderTrackingModal = document.getElementById('order-tracking-modal');
        const paymentWarrantyModal = document.getElementById('payment-warranty-modal');

        const closeProductModalBtn = document.getElementById('close-product-modal');
        const closeOrderModalBtn = document.getElementById('close-order-modal');
        const closeEditShippingModalBtn = document.getElementById('close-edit-shipping-modal');
        const closeManagementModalBtn = document.getElementById('close-management-modal');
        const closeSettingsModalBtn = document.getElementById('close-settings-modal');
        const closeAnalyticsModalBtn = document.getElementById('close-analytics-modal');
        const closeCartModalBtn = document.getElementById('close-cart-modal');
        const closePaymentVATModalBtn = document.getElementById('close-payment-vat-modal');
        const closeOrderTrackingModalBtn = document.getElementById('close-order-tracking-modal');
        const closePaymentWarrantyModalBtn = document.getElementById('close-payment-warranty-modal');
        const closeLoginRegisterModalBtn = document.getElementById('close-login-register-modal');
        const closeProfileModalBtn = document.getElementById('close-profile-modal-btn');

        const showProductsBtn = document.getElementById('show-products-btn');
        const showCreatedOrdersBtn = document.getElementById('show-created-orders-btn');
        const showShippingOrdersBtn = document.getElementById('show-shipping-orders-btn');
        const showDeliveredOrdersBtn = document.getElementById('show-delivered-orders-btn');
        const openManagementModalBtn = document.getElementById('open-management-modal-btn');
        const openSettingsModalBtn = document.getElementById('open-settings-modal-btn');
        const openShopAnalyticsModalBtn = document.getElementById('open-shop-analytics-modal-btn');
        const openCartModalBtn = document.getElementById('open-cart-modal-btn');
        const loginStatusBtn = document.getElementById('login-status-btn');
        const openProfileModalBtn = document.getElementById('open-profile-modal-btn');

        const productListSection = document.getElementById('product-list-section');
        const createdOrdersSection = document.getElementById('created-orders-section');
        const shippingOrdersSection = document.getElementById('shipping-orders-section');
        const deliveredOrdersSection = document.getElementById('delivered-orders-section');

        const allTabButtons = document.querySelectorAll('.tab-button');
        const allSections = document.querySelectorAll('section > div');

        const modalProductName = document.getElementById('modal-product-name');
        const modalProductImage = document.getElementById('modal-product-image');
        const modalProductBasePrice = document.getElementById('modal-product-base-price');
        const modalProductPriceDisplay = document.getElementById('modal-product-price-display');
        const modalProductVATDisplay = document.getElementById('modal-product-vat-display');
        const modalProductDiscountDisplay = document.getElementById('modal-product-discount-display');
        const modalProductSold = document.getElementById('modal-product-sold');
        const modalProductRemaining = document.getElementById('modal-product-remaining');
        const modalProductDescription = document.getElementById('modal-product-description');
        const modalShippingCostDisplay = document.getElementById('modal-shipping-cost-display');
        const productOptionsContainer = document.getElementById('product-options');
        const voucherCodeInput = document.getElementById('voucher-code');
        const applyVoucherBtn = document.getElementById('apply-voucher-btn');
        const buyNowDetailBtn = document.getElementById('buy-now-detail-btn');
        const addToCartDetailBtn = document.getElementById('add-to-cart-detail-btn');

        const orderIdDisplay = document.getElementById('order-id-display');
        const orderProductsSummary = document.getElementById('order-products-summary');
        const customerNameInput = document.getElementById('customer-name');
        const customerPhoneInput = document.getElementById('customer-phone');
        const customerAddressInput = document.getElementById('customer-address');
        const orderLocationInput = document.getElementById('order-location');
        const estimatedDeliveryDateInput = document.getElementById('estimated-delivery-date');
        const orderForm = document.getElementById('order-form');
        const orderStatusSteps = document.querySelectorAll('.order-status-step');
        const viewOnMapBtn = document.getElementById('view-on-map-btn');

        const editShippingOrderIdDisplay = document.getElementById('edit-shipping-order-id-display');
        const editShippingOrderHiddenId = document.getElementById('edit-shipping-order-hidden-id');
        const editOrderLocationInput = document.getElementById('edit-order-location');
        const editEstimatedDeliveryDateInput = document.getElementById('edit-estimated-delivery-date');
        const editShippingOrderForm = document.getElementById('edit-shipping-order-form');

        const cartCountSpan = document.getElementById('cart-count');
        const searchCartItemsInput = document.getElementById('search-cart-items');
        const clearSearchCartItemsBtn = document.getElementById('clear-search-cart-items');
        const cartItemsList = document.getElementById('cart-items-list');
        const cartTotalAmountSpan = document.getElementById('cart-total-amount');
        const buyAllCartBtn = document.getElementById('buy-all-cart-btn');

        const productManagementList = document.getElementById('product-management-list');
        const addEditProductTitle = document.getElementById('add-edit-product-title');
        const addEditProductForm = document.getElementById('add-edit-product-form');
        const editProductIdInput = document.getElementById('edit-product-id');
        const newProductNameInput = document.getElementById('new-product-name');
        const newProductBasePriceInput = document.getElementById('new-product-base-price');
        const newProductImageInput = document.getElementById('new-product-image');
        const newProductDescriptionInput = document.getElementById('new-product-description');
        const newProductReviewsInput = document.getElementById('new-product-reviews');
        const colorOptionsContainer = document.getElementById('color-options-container');
        const addColorOptionBtn = document.getElementById('add-color-option-btn');
        const storageOptionsContainer = document.getElementById('storage-options-container');
        const addStorageOptionBtn = document.getElementById('add-storage-option-btn');
        const variantsContainer = document.getElementById('variants-container');
        const addVariantBtn = document.getElementById('add-variant-btn');
        const submitProductBtn = document.getElementById('submit-product-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const addVoucherForm = document.getElementById('add-voucher-form');
        const newVoucherCodeInput = document.getElementById('new-voucher-code');
        const newVoucherValueInput = document.getElementById('new-voucher-value');
        const currentVouchersList = document.getElementById('current-vouchers-list');

        const addEditWarrantyPackageForm = document.getElementById('add-edit-warranty-package-form');
        const editWarrantyPackageIdInput = document.getElementById('edit-warranty-package-id');
        const newWarrantyPackageNameInput = document.getElementById('new-warranty-package-name');
        const newWarrantyPackagePriceInput = document.getElementById('new-warranty-package-price');
        const newWarrantyPackageDiscountInput = document.getElementById('new-warranty-package-discount');
        const submitWarrantyPackageBtn = document.getElementById('submit-warranty-package-btn');
        const cancelEditWarrantyPackageBtn = document.getElementById('cancel-edit-warranty-package-btn');
        const currentWarrantyPackagesList = document.getElementById('current-warranty-packages-list');

        const shopSettingsForm = document.getElementById('shop-settings-form');
        const shopNameInput = document.getElementById('shop-name-input');
        const shopAddressInput = document.getElementById('shop-address-input');
        const backgroundImageURLInput = document.getElementById('background-image-url');
        const advertisementTextInput = document.getElementById('advertisement-text-input');
        const advertisementAnimationSelect = document.getElementById('advertisement-animation-select');
        const bankNameInput = document.getElementById('bank-name-input');
        const accountNumberInput = document.getElementById('account-number-input');
        const accountHolderInput = document.getElementById('account-holder-input');
        const qrCodeImageURLInput = document.getElementById('qr-code-image-url-input');
        const uploadQrCodeBtn = document.getElementById('upload-qr-code-btn');
        const shippingUnitNameInput = document.getElementById('shipping-unit-name-input');
        const shippingUnitImageURLInput = document.getElementById('shipping-unit-image-url-input');
        const uploadShippingUnitImageBtn = document.getElementById('upload-shipping-unit-image-btn');

        const reportStartDateInput = document.getElementById('report-start-date');
        const reportEndDateInput = document.getElementById('report-end-date');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const totalRevenueDisplay = document.getElementById('total-revenue-display');
        const totalOrdersDisplay = document.getElementById('total-orders-display');
        const topSellingProductsList = document.getElementById('top-selling-products-list');

        const qrCodeDisplay = document.getElementById('qr-code-display');
        const bankNameDisplay = document.getElementById('bank-name-display');
        const accountNumberDisplay = document.getElementById('account-number-display');
        const accountHolderDisplay = document.getElementById('account-holder-display');
        const vatBaseAmountDisplay = document.getElementById('vat-base-amount');
        // New elements for VAT breakdown display
        const totalVatOriginalDisplay = document.getElementById('total-vat-original-display');
        const shopSupportVatDisplay = document.getElementById('shop-support-vat-display');
        const paymentModalVATTotal = document.getElementById('payment-modal-vat-total');
        const paymentAmountInput = document.getElementById('payment-amount-input');
        const amountPaidDisplay = document.getElementById('amount-paid-display');
        const remainingPaymentDisplay = document.getElementById('remaining-payment-display');
        const confirmPaymentBtn = document.getElementById('confirm-payment-btn');
        const adminConfirmVatPaymentBtn = document.getElementById('admin-confirm-vat-payment-btn');

        const trackingShippingUnitImage = document.getElementById('tracking-shipping-unit-image');
        const trackingShippingUnitName = document.getElementById('tracking-shipping-unit-name');
        const trackingOrderId = document.getElementById('tracking-order-id');
        const trackingProductDetails = document.getElementById('tracking-product-details');
        const trackingCurrentLocation = document.getElementById('tracking-current-location');
        const trackingDestination = document.getElementById('tracking-destination');
        const checkRouteBtn = document.getElementById('check-route-btn');

        const warrantyPackagesSelection = document.getElementById('warranty-packages-selection');
        const qrCodeDisplayWarranty = document.getElementById('qr-code-display-warranty');
        const bankNameDisplayWarranty = document.getElementById('bank-name-display-warranty');
        const accountNumberDisplayWarranty = document.getElementById('account-number-display-warranty');
        const accountHolderDisplayWarranty = document.getElementById('account-holder-display-warranty');
        const warrantyPaymentTotal = document.getElementById('warranty-payment-total');
        const confirmWarrantyPaymentBtn = document.getElementById('confirm-warranty-payment-btn');
        const adminConfirmWarrantyBtn = document.getElementById('admin-confirm-warranty-btn');

        const loginRegisterModal = document.getElementById('login-register-modal');
        const authModalTitle = document.getElementById('auth-modal-title');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterFormLink = document.getElementById('show-register-form-link');
        const showLoginFormLink = document.getElementById('show-login-form-link');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const loginSubmitBtn = document.getElementById('login-submit-btn');
        const loginErrorMessage = document.getElementById('login-error-message');
        const registerUsernameInput = document.getElementById('register-username');
        const registerPasswordInput = document.getElementById('register-password');
        const registerConfirmPasswordInput = document.getElementById('register-confirm-password');
        const registerFullnameInput = document.getElementById('register-fullname');
        const registerPhoneInput = document.getElementById('register-phone');
        const registerProvinceInput = document.getElementById('register-province');
        const registerSubmitBtn = document.getElementById('register-submit-btn');
        const registerErrorMessage = document.getElementById('register-error-message');

        const profileModal = document.getElementById('profile-modal');
        const profileUsernameInput = document.getElementById('profile-username');
        const profileFullnameInput = document.getElementById('profile-fullname');
        const profilePhoneInput = document.getElementById('profile-phone');
        const profileProvinceInput = document.getElementById('profile-province');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const profileErrorMessage = document.getElementById('profile-error-message');


        let currentSelectedProduct = null;
        let currentSelectedOptions = {};
        let currentCalculatedPrice = 0;
        let currentAppliedVoucher = null;
        let productsToOrder = [];
        let currentOrderForPayment = null;
        let isBuyNowFlow = false;
        let currentOrderForTracking = null;
        let currentOrderForWarranty = null;
        let selectedWarrantyPackage = null;
        let currentPriceBeforeVoucherAndVAT = 0; // This will now represent the price before any VAT or discounts

        const shippingZones = {
            'mienBac': { cost: 0, provinces: ['Hà Nội', 'Hải Phòng', 'Quảng Ninh', 'Bắc Ninh', 'Hải Dương', 'Hưng Yên', 'Vĩnh Phúc', 'Thái Nguyên', 'Phú Thọ', 'Bắc Giang', 'Lạng Sơn', 'Cao Bằng', 'Hà Giang', 'Tuyên Quang', 'Lai Châu', 'Điện Biên', 'Sơn La', 'Hòa Bình', 'Yên Bái', 'Lào Cai'] },
            'mienTrung': { cost: 0, provinces: ['Đà Nẵng', 'Thừa Thiên Huế', 'Quảng Nam', 'Quảng Ngãi', 'Bình Định', 'Phú Yên', 'Khánh Hòa', 'Ninh Thuận', 'Bình Thuận', 'Kon Tum', 'Gia Lai', 'Đắk Lắk', 'Đắk Nông', 'Lâm Đồng', 'Thanh Hóa', 'Nghệ An', 'Hà Tĩnh', 'Quảng Bình', 'Quảng Trị'] },
            'mienNam': { cost: 0, provinces: ['TP. Hồ Chí Minh', 'Cần Thơ', 'Bình Dương', 'Đồng Nai', 'Bà Rịa - Vũng Tàu', 'Long An', 'Tiền Giang', 'Bến Tre', 'Trà Vinh', 'Vĩnh Long', 'Đồng Tháp', 'An Giang', 'Kiên Giang', 'Hậu Giang', 'Sóc Trăng', 'Bạc Liêu', 'Cà Mau'] },
            'default': { cost: 0 }
        };

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        function generateId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function openModal(modalElement) {
            modalElement.classList.remove('hidden');
            modalElement.classList.add('active');
            document.body.classList.add('overflow-hidden');
        }

        function closeModal(modalElement) {
            modalElement.classList.remove('active');
            modalElement.addEventListener('transitionend', () => {
                modalElement.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }, { once: true });
        }

        function showSection(sectionId, clickedButton) {
            allSections.forEach(section => section.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            allTabButtons.forEach(btn => btn.classList.remove('active'));
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
        }

        async function loadShopData() {
            showLoading();
            try {
                // Corrected Firestore path for shopData: artifacts/{appId}/public/data/shopSettings/shopData
                const shopDocRef = doc(collection(db, `artifacts/${appId}/public/data/shopSettings`), 'shopData');
                const shopDocSnap = await getDoc(shopDocRef);
                if (shopDocSnap.exists()) {
                    shopDataCache = { ...shopDataCache, ...shopDocSnap.data() };
                    console.log("Shop data loaded from Firestore:", shopDataCache);
                } else {
                    console.log("No shop data found in Firestore. Initializing with default data.");
                    // Initialize with default data if document doesn't exist
                    await setDoc(shopDocRef, shopDataCache);
                    console.log("Default shop data saved to Firestore.");
                }

                // Check if products array is empty and add a default product if it is
                if (!shopDataCache.products || shopDataCache.products.length === 0) {
                    const defaultProduct = {
                        id: generateId(),
                        name: 'iPhone 16 Pro Max',
                        basePrice: 30000000,
                        image: 'https://placehold.co/400x300/cccccc/333333?text=iPhone+16+Pro+Max',
                        description: 'iPhone 16 Pro Max là siêu phẩm mới nhất của Apple, với chip A18 Bionic mạnh mẽ, camera cải tiến vượt trội và màn hình ProMotion siêu mượt.',
                        reviewsCount: 500,
                        colors: [
                            { name: 'Titan Tự Nhiên', priceImpact: 0, display_image: 'https://placehold.co/400x300/8B8B8B/ffffff?text=Titan+Tự+Nhiên' },
                            { name: 'Titan Xanh', priceImpact: 500000, display_image: 'https://placehold.co/400x300/00008B/ffffff?text=Titan+Xanh' },
                            { name: 'Titan Trắng', priceImpact: 500000, display_image: 'https://placehold.co/400x300/F0F8FF/333333?text=Titan+Trắng' },
                            { name: 'Titan Đen', priceImpact: 0, display_image: 'https://placehold.co/400x300/2C3539/ffffff?text=Titan+Đen' }
                        ],
                        storages: [
                            { name: '256GB', priceImpact: 0 },
                            { name: '512GB', priceImpact: 3000000 },
                            { name: '1TB', priceImpact: 7000000 }
                        ],
                        variants: [
                            { color: 'Titan Tự Nhiên', storage: '256GB', quantity: 100, priceImpact: 0, sold: 20 },
                            { color: 'Titan Tự Nhiên', storage: '512GB', quantity: 70, priceImpact: 0, sold: 15 },
                            { color: 'Titan Tự Nhiên', storage: '1TB', quantity: 30, priceImpact: 0, sold: 5 },
                            { color: 'Titan Xanh', storage: '256GB', quantity: 80, priceImpact: 0, sold: 10 },
                            { color: 'Titan Xanh', storage: '512GB', quantity: 50, priceImpact: 0, sold: 8 },
                            { color: 'Titan Xanh', storage: '1TB', quantity: 20, priceImpact: 0, sold: 3 },
                            { color: 'Titan Trắng', storage: '256GB', quantity: 90, priceImpact: 0, sold: 18 },
                            { color: 'Titan Trắng', storage: '512GB', quantity: 60, priceImpact: 0, sold: 12 },
                            { color: 'Titan Trắng', storage: '1TB', quantity: 25, priceImpact: 0, sold: 4 },
                            { color: 'Titan Đen', storage: '256GB', quantity: 95, priceImpact: 0, sold: 22 },
                            { color: 'Titan Đen', storage: '512GB', quantity: 65, priceImpact: 0, sold: 10 },
                            { color: 'Titan Đen', storage: '1TB', quantity: 28, priceImpact: 0, sold: 6 }
                        ]
                    };
                    shopDataCache.products = [defaultProduct];
                    await setDoc(shopDocRef, shopDataCache); // Save the default product to Firestore
                    showMessage('Đã tạo sản phẩm mặc định iPhone 16 Pro Max.', 'info');
                    console.log("Default iPhone 16 Pro Max product added and saved.");
                }

                loadShopSettingsToUI();
                renderProducts();
                renderProductManagementList();
                renderVouchersList();
                renderWarrantyPackagesList();
            } catch (error) {
                console.error("Error loading shop data:", error);
                showMessage(`Lỗi tải dữ liệu cửa hàng: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function saveShopData() {
            showLoading();
            try {
                // Corrected Firestore path for shopData
                await setDoc(doc(collection(db, `artifacts/${appId}/public/data/shopSettings`), 'shopData'), shopDataCache);
                showMessage('Dữ liệu cửa hàng đã được lưu!', 'success');
                console.log("Shop data successfully saved to Firestore.");
            } catch (error) {
                console.error("Error saving shop data:", error);
                showMessage(`Lỗi lưu dữ liệu cửa hàng: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadShopSettingsToUI() {
            shopNameDisplay.innerHTML = `<i class="fas fa-mobile-alt mr-2 text-gray-700"></i><span class="text-gray-900">${shopDataCache.name.replace('.com', '')}</span><span class="text-red-600">.com</span>`;
            pageTitle.textContent = shopDataCache.name;
            shopAddressDisplay.textContent = shopDataCache.address;

            if (shopDataCache.backgroundImg) {
                bodyElement.style.backgroundImage = `url('${shopDataCache.backgroundImg}')`;
            } else {
                bodyElement.style.backgroundImage = 'none';
                bodyElement.style.backgroundColor = '#fdf8f4';
            }

            shopNameInput.value = shopDataCache.name || '';
            shopAddressInput.value = shopDataCache.address || '';
            backgroundImageURLInput.value = shopDataCache.backgroundImg || '';
            advertisementTextInput.value = shopDataCache.advertisement.text || '';
            advertisementAnimationSelect.value = shopDataCache.advertisement.animation || 'none';
            bankNameInput.value = shopDataCache.bankDetails.bankName || '';
            accountNumberInput.value = shopDataCache.bankDetails.accountNumber || '';
            accountHolderInput.value = shopDataCache.bankDetails.accountHolder || '';
            qrCodeImageURLInput.value = shopDataCache.bankDetails.qrCodeImage || '';
            shippingUnitNameInput.value = shopDataCache.shippingUnit.name || 'GHN Express';
            shippingUnitImageURLInput.value = shopDataCache.shippingUnit.image || '';

            updateAdvertisementBanner();
        }

        function updateAdvertisementBanner() {
            const adText = shopDataCache.advertisement.text;
            const adAnimation = shopDataCache.advertisement.animation;
            if (adText) {
                advertisementContent.textContent = adText;
                advertisementBannerContainer.classList.remove('hidden');
                advertisementBannerContainer.classList.remove('marquee', 'flicker');
                if (adAnimation === 'marquee') {
                    advertisementBannerContainer.classList.add('marquee');
                } else if (adAnimation === 'flicker') {
                    advertisementBannerContainer.classList.add('flicker');
                }
            } else {
                advertisementBannerContainer.classList.add('hidden');
                advertisementContent.textContent = '';
            }
        }

        shopSettingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!loggedInUser || !loggedInUser.isAdmin) {
                showMessage('Chờ admin kiểm duyệt', 'info');
                return;
            }
            showLoading();
            shopDataCache.name = shopNameInput.value.trim();
            shopDataCache.address = shopAddressInput.value.trim();
            shopDataCache.backgroundImg = backgroundImageURLInput.value.trim();
            shopDataCache.advertisement.text = advertisementTextInput.value.trim();
            shopDataCache.advertisement.animation = advertisementAnimationSelect.value;
            shopDataCache.bankDetails.bankName = bankNameInput.value.trim();
            shopDataCache.bankDetails.accountNumber = accountNumberInput.value.trim();
            shopDataCache.bankDetails.accountHolder = accountHolderInput.value.trim();
            shopDataCache.bankDetails.qrCodeImage = qrCodeImageURLInput.value.trim();
            shopDataCache.shippingUnit.name = shippingUnitNameInput.value.trim();
            shopDataCache.shippingUnit.image = shippingUnitImageURLInput.value.trim();
            await saveShopData();
            loadShopSettingsToUI();
            hideLoading();
            closeModal(shopSettingsModal);
        });

        document.getElementById('upload-main-image-btn').addEventListener('click', () => {
            if (!loggedInUser || !loggedInUser.isAdmin) {
                showMessage('Chờ admin kiểm duyệt', 'info');
                return;
            }
            const imageUrl = prompt('Nhập URL hình ảnh sản phẩm (URL trực tiếp, GitHub Raw, hoặc chuỗi Base64):');
            if (imageUrl) {
                newProductImageInput.value = imageUrl;
            }
        });
        document.getElementById('upload-background-btn').addEventListener('click', () => {
            if (!loggedInUser || !loggedInUser.isAdmin) {
                showMessage('Chờ admin kiểm duyệt', 'info');
                return;
            }
            const imageUrl = prompt('Nhập URL hình ảnh nền (URL trực tiếp, GitHub Raw, hoặc chuỗi Base64):');
            if (imageUrl) {
                backgroundImageURLInput.value = imageUrl;
            }
        });
        uploadQrCodeBtn.addEventListener('click', () => {
            if (!loggedInUser || !loggedInUser.isAdmin) {
                showMessage('Chờ admin kiểm duyệt', 'info');
                return;
            }
            const imageUrl = prompt('Nhập URL hình ảnh QR Code ngân hàng (URL trực tiếp, GitHub Raw, hoặc chuỗi Base64):');
            if (imageUrl) {
                qrCodeImageURLInput.value = imageUrl;
            }
        });
        uploadShippingUnitImageBtn.addEventListener('click', () => {
            if (!loggedInUser || !loggedInUser.isAdmin) {
                showMessage('Chờ admin kiểm duyệt', 'info');
                return;
            }
            const imageUrl = prompt('Nhập URL hình ảnh đơn vị vận chuyển (URL trực tiếp, GitHub Raw, hoặc chuỗi Base64):');
            if (imageUrl) {
                shippingUnitImageURLInput.value = imageUrl;
            }
        });

        closeProductModalBtn.addEventListener('click', () => closeModal(productDetailModal));
        closeOrderModalBtn.addEventListener('click', () => closeModal(orderCreationModal));
        closeEditShippingModalBtn.addEventListener('click', () => closeModal(editShippingOrderModal));
        closeManagementModalBtn.addEventListener('click', () => closeModal(shopManagementModal));
        closeSettingsModalBtn.addEventListener('click', () => closeModal(shopSettingsModal));
        closeAnalyticsModalBtn.addEventListener('click', () => closeModal(shopAnalyticsModal));
        closeCartModalBtn.addEventListener('click', () => closeModal(cartModal));
        closePaymentVATModalBtn.addEventListener('click', () => closeModal(paymentVATModal));
        closeOrderTrackingModalBtn.addEventListener('click', () => closeModal(orderTrackingModal));
        closePaymentWarrantyModalBtn.addEventListener('click', () => closeModal(paymentWarrantyModal));
        closeLoginRegisterModalBtn.addEventListener('click', () => closeModal(loginRegisterModal));
        closeProfileModalBtn.addEventListener('click', () => closeModal(profileModal));

        productDetailModal.addEventListener('click', (e) => { if (e.target === productDetailModal) closeModal(productDetailModal); });
        orderCreationModal.addEventListener('click', (e) => { if (e.target === orderCreationModal) closeModal(orderCreationModal); });
        editShippingOrderModal.addEventListener('click', (e) => { if (e.target === editShippingOrderModal) closeModal(editShippingOrderModal); });
        shopManagementModal.addEventListener('click', (e) => { if (e.target === shopManagementModal) closeModal(shopManagementModal); });
        shopSettingsModal.addEventListener('click', (e) => { if (e.target === shopSettingsModal) closeModal(shopSettingsModal); });
        shopAnalyticsModal.addEventListener('click', (e) => { if (e.target === shopAnalyticsModal) closeModal(shopAnalyticsModal); });
        cartModal.addEventListener('click', (e) => { if (e.target === cartModal) closeModal(cartModal); });
        paymentVATModal.addEventListener('click', (e) => { if (e.target === paymentVATModal) closeModal(paymentVATModal); });
        orderTrackingModal.addEventListener('click', (e) => { if (e.target === orderTrackingModal) closeModal(orderTrackingModal); });
        paymentWarrantyModal.addEventListener('click', (e) => { if (e.target === paymentWarrantyModal) closeModal(paymentWarrantyModal); });
        loginRegisterModal.addEventListener('click', (e) => { if (e.target === loginRegisterModal) closeModal(loginRegisterModal); });
        profileModal.addEventListener('click', (e) => { if (e.target === profileModal) closeModal(profileModal); });

        openManagementModalBtn.addEventListener('click', () => {
            if (!loggedInUser) {
                showMessage('Vui lòng đăng nhập để sử dụng chức năng này.', 'info');
                openModal(loginRegisterModal); // Show login modal
                return;
            }
            if (!loggedInUser.isAdmin) {
                showMessage('Chờ admin kiểm duyệt', 'info');
                return;
            }
            openModal(shopManagementModal);
            renderProductManagementList();
            renderVouchersList();
            renderWarrantyPackagesList();
            resetAddEditProductForm();
            resetAddEditWarrantyPackageForm();
        });
        openSettingsModalBtn.addEventListener('click', () => {
            if (!loggedInUser) {
                showMessage('Vui lòng đăng nhập để sử dụng chức năng này.', 'info');
                openModal(loginRegisterModal); // Show login modal
                return;
            }
            if (!loggedInUser.isAdmin) {
                showMessage('Chờ admin kiểm duyệt', 'info');
                return;
            }
            openModal(shopSettingsModal);
        });
        openShopAnalyticsModalBtn.addEventListener('click', () => {
            if (!loggedInUser) {
                showMessage('Vui lòng đăng nhập để sử dụng chức năng này.', 'info');
                openModal(loginRegisterModal); // Show login modal
                return;
            }
            if (!loggedInUser.isAdmin) {
                showMessage('Chờ admin kiểm duyệt', 'info');
                return;
            }
            openModal(shopAnalyticsModal);
            generateShopReport();
        });
        openCartModalBtn.addEventListener('click', () => {
            if (!loggedInUser || !loggedInUser.id) { // Check if user is truly not logged in (id is null for guest)
                showMessage('Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng.', 'info');
                openModal(loginRegisterModal); // Show login modal
                return;
            }
            openModal(cartModal);
            renderCart();
        });

        showProductsBtn.addEventListener('click', (e) => showSection('product-list-section', e.target));
        showCreatedOrdersBtn.addEventListener('click', (e) => {
            if (!loggedInUser || !loggedInUser.id) { // Check if user is truly not logged in (id is null for guest)
                showMessage('Vui lòng đăng nhập để xem đơn hàng.', 'info');
                openModal(loginRegisterModal); // Show login modal
                return;
            }
            showSection('created-orders-section', e.target);
            renderOrders('created');
        });
        showShippingOrdersBtn.addEventListener('click', (e) => {
            if (!loggedInUser || !loggedInUser.id) { // Check if user is truly not logged in (id is null for guest)
                showMessage('Vui lòng đăng nhập để xem đơn hàng.', 'info');
                openModal(loginRegisterModal); // Show login modal
                return;
            }
            showSection('shipping-orders-section', e.target);
            renderOrders('shipping');
        });
        showDeliveredOrdersBtn.addEventListener('click', (e) => {
            if (!loggedInUser || !loggedInUser.id) { // Check if user is truly not logged in (id is null for guest)
                showMessage('Vui lòng đăng nhập để xem đơn hàng.', 'info');
                openModal(loginRegisterModal); // Show login modal
                return;
            }
            showSection('delivered-orders-section', e.target);
            renderOrders('delivered');
        });
        openProfileModalBtn.addEventListener('click', () => {
            if (!loggedInUser || !loggedInUser.id) { // Check if user is truly not logged in (id is null for guest)
                showMessage('Vui lòng đăng nhập để xem hồ sơ.', 'info');
                openModal(loginRegisterModal); // Show login modal
                return;
            }
            renderProfileModal();
            openModal(profileModal);
        });

        document.querySelectorAll('.toggle-visibility-btn').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.dataset.targetId;
                const targetInput = document.getElementById(targetId);
                const isBlurred = targetInput.classList.contains('blurred-content');
                if (isBlurred) {
                    targetInput.classList.remove('blurred-content');
                    this.innerHTML = '<i class="fas fa-eye"></i>';
                } else {
                    targetInput.classList.add('blurred-content');
                    this.innerHTML = '<i class="fas fa-eye-slash"></i>';
                }
            });
        });

        headerProductSearchInput.addEventListener('input', () => {
            renderProducts(headerProductSearchInput.value.trim());
        });

        function renderProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card bg-white rounded-xl shadow-lg p-6 flex flex-col items-center text-center hover:shadow-xl transition-shadow duration-300 relative';
            const starsHtml = '<div class="star-rating text-yellow-400 mb-2">' + '<i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>' + ` <span class="text-gray-600 text-sm">(${product.reviewsCount || 0} đánh giá)</span>` + '</div>';
            card.innerHTML = `
                <img src="${product.image}" onerror="this.onerror=null;this.src='https://placehold.co/300x200/cccccc/333333?text=No+Image';" alt="${product.name}" class="w-full h-48 object-cover rounded-lg mb-4 shadow-md">
                <h3 class="text-xl font-semibold mb-2 text-gray-900">${product.name}</h3>
                <p class="text-lg text-gray-700">Giá gốc: <span class="font-bold">${formatCurrency(product.basePrice)}</span></p>
                ${starsHtml}
                <button data-product-id="${product.id}" class="view-product-btn mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-full transition-all duration-200 shadow-md">Xem chi tiết</button>
            `;
            return card;
        }

        function renderProducts(searchTerm = '') {
            const productGrid = document.getElementById('product-grid');
            productGrid.innerHTML = '';
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const filteredProducts = shopDataCache.products.filter(product =>
                product.name.toLowerCase().includes(lowerCaseSearchTerm) ||
                product.description.toLowerCase().includes(lowerCaseSearchTerm)
            );

            if (filteredProducts.length === 0) {
                productGrid.innerHTML = '<p class="text-gray-500 italic text-center col-span-full">Không tìm thấy sản phẩm nào.</p>';
                return;
            }

            filteredProducts.forEach(product => {
                productGrid.appendChild(renderProductCard(product));
            });

            document.querySelectorAll('.view-product-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.target.dataset.productId;
                    const product = shopDataCache.products.find(p => p.id === productId);
                    if (product) {
                        // Check if user is logged in before displaying product detail
                        if (!loggedInUser || !loggedInUser.id) {
                            showMessage('Vui lòng đăng nhập để xem chi tiết sản phẩm.', 'info');
                            openModal(loginRegisterModal); // Show login modal
                            return;
                        }
                        displayProductDetail(product);
                    }
                });
            });
        }

        function displayProductDetail(product) {
            currentSelectedProduct = product;
            currentSelectedOptions = {};
            currentAppliedVoucher = null;
            voucherCodeInput.value = '';
            modalProductName.textContent = product.name;
            modalProductImage.src = product.image;
            modalProductBasePrice.textContent = formatCurrency(product.basePrice);
            modalProductDescription.textContent = product.description;
            productOptionsContainer.innerHTML = '';

            if (product.colors && product.colors.length > 0) {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'flex flex-col space-y-2';
                colorDiv.innerHTML = '<p class="text-gray-700 font-semibold mb-2">Màu sắc:</p>';
                const colorButtonsDiv = document.createElement('div');
                colorButtonsDiv.className = 'flex flex-wrap gap-2';
                product.colors.forEach(color => {
                    const btn = document.createElement('button');
                    btn.className = 'option-button bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-full transition-all duration-200 text-sm';
                    btn.textContent = color.name;
                    btn.dataset.type = 'color';
                    btn.dataset.value = color.name;
                    btn.dataset.priceImpact = color.priceImpact;
                    btn.dataset.displayImage = color.display_image || '';
                    colorButtonsDiv.appendChild(btn);
                    btn.addEventListener('click', () => selectOption('color', color.name, color.priceImpact, btn, color.display_image));
                });
                colorDiv.appendChild(colorButtonsDiv);
                productOptionsContainer.appendChild(colorDiv);
                selectOption('color', product.colors[0].name, product.colors[0].priceImpact, colorButtonsDiv.children[0], product.colors[0].display_image);
            } else {
                currentSelectedOptions.color = null;
            }

            if (product.storages && product.storages.length > 0) {
                const storageDiv = document.createElement('div');
                storageDiv.className = 'flex flex-col space-y-2';
                storageDiv.innerHTML = '<p class="text-gray-700 font-semibold mb-2">Dung lượng:</p>';
                const storageButtonsDiv = document.createElement('div');
                storageButtonsDiv.className = 'flex flex-wrap gap-2';
                product.storages.forEach(storage => {
                    const btn = document.createElement('button');
                    btn.className = 'option-button bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-full transition-all duration-200 text-sm';
                    btn.textContent = storage.name;
                    btn.dataset.type = 'storage';
                    btn.dataset.value = storage.name;
                    btn.dataset.priceImpact = storage.priceImpact;
                    storageButtonsDiv.appendChild(btn);
                    btn.addEventListener('click', () => selectOption('storage', storage.name, storage.priceImpact, btn));
                });
                storageDiv.appendChild(storageButtonsDiv);
                productOptionsContainer.appendChild(storageDiv);
                selectOption('storage', product.storages[0].name, product.storages[0].priceImpact, storageButtonsDiv.children[0]);
            } else {
                currentSelectedOptions.storage = null;
            }
            calculateProductPrice();
            openModal(productDetailModal);
        }

        function selectOption(type, value, priceImpact, button, displayImage = null) {
            document.querySelectorAll(`.option-button[data-type="${type}"]`).forEach(btn => {
                btn.classList.remove('selected');
            });
            if (button) {
                button.classList.add('selected');
            }
            currentSelectedOptions[type] = { value, priceImpact: parseFloat(priceImpact) };
            if (type === 'color' && displayImage) {
                modalProductImage.src = displayImage;
            } else if (type === 'color' && !displayImage) {
                modalProductImage.src = currentSelectedProduct.image;
            }
            calculateProductPrice();
        }

        function calculateProductPrice() {
            let basePrice = currentSelectedProduct.basePrice;
            let priceAfterOptions = basePrice;

            for (const type in currentSelectedOptions) {
                priceAfterOptions += (currentSelectedOptions[type] && currentSelectedOptions[type].priceImpact) || 0;
            }

            const selectedColor = currentSelectedOptions.color ? currentSelectedOptions.color.value : null;
            const selectedStorage = currentSelectedOptions.storage ? currentSelectedOptions.storage.value : null;

            let variant = null;
            if (currentSelectedProduct.variants) {
                variant = currentSelectedProduct.variants.find(v =>
                    v.color === selectedColor && v.storage === selectedStorage
                );
            }

            let finalPrice = priceAfterOptions;
            let remainingQuantity = 'N/A';
            let soldQuantity = 'N/A';

            if (variant) {
                finalPrice += variant.priceImpact || 0;
                remainingQuantity = variant.quantity !== undefined ? variant.quantity : 'N/A';
                soldQuantity = variant.sold !== undefined ? variant.sold : 'N/A';
                if (remainingQuantity <= 0) {
                    buyNowDetailBtn.disabled = true;
                    addToCartDetailBtn.disabled = true;
                    modalProductRemaining.classList.add('out-of-stock');
                    modalProductRemaining.textContent = 'Hết hàng';
                } else {
                    buyNowDetailBtn.disabled = false;
                    addToCartDetailBtn.disabled = false;
                    modalProductRemaining.classList.remove('out-of-stock');
                    modalProductRemaining.textContent = remainingQuantity;
                }
            } else {
                buyNowDetailBtn.disabled = false;
                addToCartDetailBtn.disabled = false;
                modalProductRemaining.classList.remove('out-of-stock');
            }

            currentPriceBeforeVoucherAndVAT = finalPrice; // This is the base price for VAT calculation

            // VAT is 10% of the product's original price
            let totalVatForProduct = currentPriceBeforeVoucherAndVAT * 0.10;
            // Customer pays 20% of the total VAT
            let customerVatPortion = totalVatForProduct * 0.20;

            let discountedPrice = finalPrice;

            if (currentAppliedVoucher) {
                if (currentAppliedVoucher.type === 'percentage') {
                    discountedPrice = finalPrice * (1 - currentAppliedVoucher.value);
                } else if (currentAppliedVoucher.type === 'fixed') {
                    discountedPrice = finalPrice - currentAppliedVoucher.value;
                } else if (currentAppliedVoucher.type === 'freeship') {
                    // Freeship logic handled at order creation/payment
                }
            }

            currentCalculatedPrice = discountedPrice; // This is the price after product options and voucher, before customer's VAT portion

            modalProductPriceDisplay.textContent = formatCurrency(finalPrice); // Display price before customer VAT portion
            modalProductVATDisplay.textContent = formatCurrency(totalVatForProduct); // Display total VAT (10% of original)
            modalProductSold.textContent = soldQuantity;
            modalProductRemaining.textContent = remainingQuantity;

            if (currentAppliedVoucher) {
                modalProductDiscountDisplay.classList.remove('hidden');
                modalProductDiscountDisplay.textContent = `Giá sau voucher: ${formatCurrency(discountedPrice)}`;
            } else {
                modalProductDiscountDisplay.classList.add('hidden');
            }
        }

        applyVoucherBtn.addEventListener('click', () => {
            const voucherCode = voucherCodeInput.value.trim().toUpperCase();
            const voucher = shopDataCache.vouchers[voucherCode];

            if (voucher) {
                currentAppliedVoucher = {
                    code: voucherCode,
                    type: typeof voucher === 'number' && voucher < 1 ? 'percentage' : (typeof voucher === 'number' ? 'fixed' : 'freeship'),
                    value: voucher
                };
                showMessage(`Áp dụng voucher "${voucherCode}" thành công!`, 'success');
            } else {
                currentAppliedVoucher = null;
                showMessage('Mã voucher không hợp lệ hoặc không tồn tại.', 'error');
            }
            calculateProductPrice();
        });

        buyNowDetailBtn.addEventListener('click', () => {
            if (!loggedInUser || !loggedInUser.id) { // Check if user is truly not logged in (id is null for guest)
                showMessage('Vui lòng đăng nhập để mua hàng.', 'info');
                openModal(loginRegisterModal); // Show login modal
                return;
            }
            productsToOrder = [{
                product: currentSelectedProduct,
                options: currentSelectedOptions,
                quantity: 1,
                priceAtOrder: currentCalculatedPrice, // Price after options and voucher
                originalPriceForVAT: currentPriceBeforeVoucherAndVAT, // Price before VAT/discount for VAT calculation
                voucher: currentAppliedVoucher
            }];
            isBuyNowFlow = true;
            openModal(orderCreationModal);
            populateOrderCreationModal();
        });

        addToCartDetailBtn.addEventListener('click', async () => {
            if (!loggedInUser || !loggedInUser.id) { // Check if user is truly not logged in (id is null for guest)
                showMessage('Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng.', 'info');
                openModal(loginRegisterModal); // Show login modal
                return;
            }
            showLoading();
            const selectedColor = currentSelectedOptions.color ? currentSelectedOptions.color.value : null;
            const selectedStorage = currentSelectedOptions.storage ? currentSelectedOptions.storage.value : null;

            const existingCartItemIndex = userCartCache.findIndex(item =>
                item.productId === currentSelectedProduct.id &&
                (item.selectedColor ? item.selectedColor.value === selectedColor : !selectedColor) &&
                (item.selectedStorage ? item.selectedStorage.value === selectedStorage : !selectedStorage)
            );

            if (existingCartItemIndex > -1) {
                userCartCache[existingCartItemIndex].quantity += 1;
            } else {
                userCartCache.push({
                    productId: currentSelectedProduct.id,
                    productName: currentSelectedProduct.name,
                    productImage: currentSelectedProduct.image,
                    selectedColor: currentSelectedOptions.color,
                    selectedStorage: currentSelectedOptions.storage,
                    priceAtAddToCart: currentCalculatedPrice, // Price after options and voucher
                    originalPriceForVAT: currentPriceBeforeVoucherAndVAT, // Price before VAT/discount for VAT calculation
                    quantity: 1
                });
            }
            await saveUserCart();
            updateCartCount();
            hideLoading();
            showMessage('Đã thêm sản phẩm vào giỏ hàng!', 'success');
        });

        async function updateCart(itemIndex, newQuantity) {
            if (!loggedInUser || !loggedInUser.id) { // Check if user is truly not logged in (id is null for guest)
                showMessage('Vui lòng đăng nhập để cập nhật giỏ hàng.', 'info');
                openModal(loginRegisterModal); // Show login modal
                return;
            }
            if (newQuantity <= 0) {
                userCartCache.splice(itemIndex, 1);
            } else {
                userCartCache[itemIndex].quantity = newQuantity;
            }
            await saveUserCart();
            renderCart();
            updateCartCount();
        }

        async function renderCart(searchTerm = '') {
            cartItemsList.innerHTML = '';
            let totalAmount = 0;
            const lowerCaseSearchTerm = searchTerm.toLowerCase();

            const filteredCart = userCartCache.filter(item =>
                item.productName.toLowerCase().includes(lowerCaseSearchTerm)
            );

            if (filteredCart.length === 0) {
                cartItemsList.innerHTML = '<p class="text-gray-500 italic text-center">Giỏ hàng trống.</p>';
                cartTotalAmountSpan.textContent = formatCurrency(0);
                return;
            }

            filteredCart.forEach((item, index) => {
                // Calculate VAT for each item based on its originalPriceForVAT
                const itemTotalVAT = item.originalPriceForVAT * 0.10; // 10% of original price
                const itemCustomerVATPortion = itemTotalVAT * 0.20; // Customer pays 20% of total VAT

                const itemTotal = (item.priceAtAddToCart + itemCustomerVATPortion) * item.quantity;
                totalAmount += itemTotal;

                const cartItemDiv = document.createElement('div');
                cartItemDiv.className = 'flex items-center space-x-4 p-4 bg-white rounded-lg shadow-md';
                cartItemDiv.innerHTML = `
                    <img src="${item.productImage}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/cccccc/333333?text=No+Image';" alt="${item.productName}" class="w-20 h-20 object-cover rounded-lg">
                    <div class="flex-1">
                        <h4 class="font-semibold text-lg text-gray-900">${item.productName}</h4>
                        <p class="text-sm text-gray-600">
                            ${item.selectedColor ? `Màu: ${item.selectedColor.value}` : ''}
                            ${item.selectedStorage ? ` - Dung lượng: ${item.selectedStorage.value}` : ''}
                        </p>
                        <p class="text-md text-gray-700">Giá (chưa VAT): ${formatCurrency(item.priceAtAddToCart)}</p>
                        <p class="text-md text-gray-700">VAT (khách trả): ${formatCurrency(itemCustomerVATPortion)}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="quantity-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded-full" data-index="${index}" data-action="decrease">-</button>
                        <span class="font-semibold text-gray-800">${item.quantity}</span>
                        <button class="quantity-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded-full" data-index="${index}" data-action="increase">+</button>
                    </div>
                    <button class="remove-from-cart-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg" data-index="${index}">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                cartItemsList.appendChild(cartItemDiv);
            });

            cartTotalAmountSpan.textContent = formatCurrency(totalAmount);

            document.querySelectorAll('.quantity-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const action = e.target.dataset.action;
                    let newQuantity = userCartCache[index].quantity;
                    if (action === 'increase') {
                        newQuantity++;
                    } else {
                        newQuantity--;
                    }
                    updateCart(index, newQuantity);
                });
            });

            document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    updateCart(index, 0);
                });
            });
        }

        buyAllCartBtn.addEventListener('click', () => {
            if (!loggedInUser || !loggedInUser.id) { // Check if user is truly not logged in (id is null for guest)
                showMessage('Vui lòng đăng nhập để mua hàng.', 'info');
                openModal(loginRegisterModal); // Show login modal
                return;
            }
            if (userCartCache.length === 0) {
                showMessage('Giỏ hàng của bạn đang trống.', 'info');
                return;
            }
            productsToOrder = userCartCache.map(item => ({
                product: shopDataCache.products.find(p => p.id === item.productId),
                options: {
                    color: item.selectedColor,
                    storage: item.selectedStorage
                },
                quantity: item.quantity,
                priceAtOrder: item.priceAtAddToCart, // Price after options and voucher
                originalPriceForVAT: item.originalPriceForVAT, // Price before VAT/discount for VAT calculation
                voucher: null
            }));
            isBuyNowFlow = false;
            openModal(orderCreationModal);
            populateOrderCreationModal();
        });

        searchCartItemsInput.addEventListener('input', () => {
            renderCart(searchCartItemsInput.value.trim());
        });
        clearSearchCartItemsBtn.addEventListener('click', () => {
            searchCartItemsInput.value = '';
            renderCart();
        });

        function populateOrderCreationModal() {
            orderIdDisplay.textContent = generateId();
            orderProductsSummary.innerHTML = '';
            let totalOrderPrice = 0;
            let totalVATCustomerPays = 0;
            let totalOriginalPrice = 0;

            productsToOrder.forEach(item => {
                const productSummaryDiv = document.createElement('div');
                productSummaryDiv.className = 'flex items-center space-x-3 mb-2';

                const itemTotalVAT = item.originalPriceForVAT * 0.10; // 10% of original price
                const itemCustomerVATPortion = itemTotalVAT * 0.20; // Customer pays 20% of total VAT

                const itemPriceIncludingCustomerVAT = item.priceAtOrder + itemCustomerVATPortion;
                const itemTotalPrice = itemPriceIncludingCustomerVAT * item.quantity;

                totalOrderPrice += itemTotalPrice;
                totalVATCustomerPays += itemCustomerVATPortion * item.quantity;
                totalOriginalPrice += item.originalPriceForVAT * item.quantity;

                productSummaryDiv.innerHTML = `
                    <img src="${item.product.image}" onerror="this.onerror=null;this.src='https://placehold.co/50x50/cccccc/333333?text=SP';" class="w-12 h-12 object-cover rounded-md">
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800">${item.product.name} ${item.options.color ? `(${item.options.color.value})` : ''} ${item.options.storage ? `(${item.options.storage.value})` : ''}</p>
                        <p class="text-sm text-gray-600">Số lượng: ${item.quantity} x ${formatCurrency(item.priceAtOrder)} (Giá gốc)</p>
                        <p class="text-sm text-gray-600">VAT (khách trả): ${formatCurrency(itemCustomerVATPortion)}</p>
                    </div>
                    <span class="font-bold text-gray-900">${formatCurrency(itemTotalPrice)}</span>
                `;
                orderProductsSummary.appendChild(productSummaryDiv);
            });

            const totalDiv = document.createElement('div');
            totalDiv.className = 'flex justify-between items-center border-t pt-2 mt-2 font-bold text-lg';
            totalDiv.innerHTML = `<span>Tổng cộng:</span><span>${formatCurrency(totalOrderPrice)}</span>`;
            orderProductsSummary.appendChild(totalDiv);

            customerNameInput.value = loggedInUser.fullname || '';
            customerPhoneInput.value = loggedInUser.phone || '';
            customerAddressInput.value = loggedInUser.province || '';
            orderLocationInput.value = DEFAULT_WAREHOUSE_ADDRESS; // Default warehouse address

            const today = new Date();
            today.setDate(today.getDate() + 3); // Estimated delivery date = current date + 3 days
            estimatedDeliveryDateInput.value = today.toISOString().split('T')[0]; // Format as YYYY-MM-DD

            orderStatusSteps.forEach(step => step.classList.remove('active'));
            document.querySelector('.order-status-step[data-status="created"]').classList.add('active');
        }

        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!loggedInUser || !loggedInUser.id) { // Check if user is truly not logged in (id is null for guest)
                showMessage('Vui lòng đăng nhập để tạo đơn hàng.', 'info');
                openModal(loginRegisterModal); // Show login modal
                return;
            }
            showLoading();

            const orderId = orderIdDisplay.textContent;
            const customerName = customerNameInput.value.trim();
            const customerPhone = customerPhoneInput.value.trim();
            const customerAddress = customerAddressInput.value.trim();
            const orderLocation = orderLocationInput.value.trim();
            const estimatedDeliveryDate = estimatedDeliveryDateInput.value;

            let totalAmount = 0; // Total amount including customer's VAT portion
            let totalVATOriginal = 0; // Total VAT (10% of original product price)
            let totalVATCustomerPays = 0; // Total VAT customer needs to pay (20% of totalVATOriginal)
            let totalShopSupportVAT = 0; // Total VAT shop supports (80% of totalVATOriginal)
            let totalOriginalProductPrice = 0; // Sum of original prices of all products

            const orderItems = productsToOrder.map(item => {
                const product = item.product;
                const selectedVariant = product.variants.find(v =>
                    v.color === (item.options.color ? item.options.color.value : null) &&
                    v.storage === (item.options.storage ? item.options.storage.value : null)
                );

                if (selectedVariant && selectedVariant.quantity < item.quantity) {
                    showMessage(`Sản phẩm "${product.name}" (${item.options.color?.value || ''} ${item.options.storage?.value || ''}) không đủ số lượng. Chỉ còn ${selectedVariant.quantity} sản phẩm.`, 'error');
                    hideLoading();
                    return null;
                }

                const itemOriginalPrice = item.originalPriceForVAT; // Price before any VAT or discounts
                const itemPriceAfterVoucher = item.priceAtOrder; // Price after options and voucher

                const itemTotalVAT = itemOriginalPrice * 0.10; // 10% of original price
                const itemCustomerVATPortion = itemTotalVAT * 0.20; // Customer pays 20% of total VAT
                const itemShopSupportVAT = itemTotalVAT * 0.80; // Shop supports 80% of total VAT

                const itemTotal = (itemPriceAfterVoucher + itemCustomerVATPortion) * item.quantity;

                totalAmount += itemTotal;
                totalVATOriginal += itemTotalVAT * item.quantity;
                totalVATCustomerPays += itemCustomerVATPortion * item.quantity;
                totalShopSupportVAT += itemShopSupportVAT * item.quantity;
                totalOriginalProductPrice += itemOriginalPrice * item.quantity;

                return {
                    productId: product.id,
                    productName: product.name,
                    productImage: product.image,
                    selectedColor: item.options.color,
                    selectedStorage: item.options.storage,
                    quantity: item.quantity,
                    priceAtOrder: itemPriceAfterVoucher, // Price after options and voucher
                    originalPriceForVAT: itemOriginalPrice, // Original price for VAT calculation
                    totalVAT: itemTotalVAT, // Total VAT for this item (10% of original)
                    customerVATPortion: itemCustomerVATPortion, // Customer's VAT portion for this item (20% of total VAT)
                    shopSupportVAT: itemShopSupportVAT, // Shop's VAT support for this item (80% of total VAT)
                    voucher: item.voucher ? { ...item.voucher } : null
                };
            }).filter(item => item !== null);

            if (orderItems.length !== productsToOrder.length) {
                hideLoading();
                return;
            }

            const newOrder = {
                id: orderId,
                userId: loggedInUser.id, // Store the user ID who created the order
                customerName,
                customerPhone,
                customerAddress,
                orderLocation,
                estimatedDeliveryDate,
                orderDate: new Date().toISOString(),
                status: 'created',
                items: orderItems,
                totalAmount: totalAmount, // Total amount including customer's VAT portion
                totalVATOriginal: totalVATOriginal, // Total VAT (10% of total original product price)
                totalVATCustomerPays: totalVATCustomerPays, // Total VAT customer needs to pay (20% of totalVATOriginal)
                totalShopSupportVAT: totalShopSupportVAT, // Total VAT shop supports (80% of totalVATOriginal)
                totalOriginalProductPrice: totalOriginalProductPrice, // Sum of original prices of all products
                vatPaymentStatus: 'pending',
                warrantyPackage: null,
                warrantyPaymentStatus: 'pending'
            };

            try {
                // Save to user's private collection
                await setDoc(doc(db, `artifacts/${appId}/users/${loggedInUser.id}/orders`, newOrder.id), newOrder);
                console.log(`Order ${newOrder.id} saved to user's collection.`);

                // Save to admin's public collection
                await setDoc(doc(collection(db, `artifacts/${appId}/public/data/adminOrders`), newOrder.id), { ...newOrder, customerUserId: loggedInUser.id });
                console.log(`Order ${newOrder.id} saved to admin collection.`);


                for (const item of productsToOrder) {
                    const productIndex = shopDataCache.products.findIndex(p => p.id === item.product.id);
                    if (productIndex > -1) {
                        const selectedColor = item.options.color ? item.options.color.value : null;
                        const selectedStorage = item.options.storage ? item.options.storage.value : null;
                        const variantIndex = shopDataCache.products[productIndex].variants.findIndex(v =>
                            v.color === selectedColor && v.storage === selectedStorage
                        );
                        if (variantIndex > -1) {
                            shopDataCache.products[productIndex].variants[variantIndex].quantity -= item.quantity;
                            shopDataCache.products[productIndex].variants[variantIndex].sold = (shopDataCache.products[productIndex].variants[variantIndex].sold || 0) + item.quantity;
                        }
                    }
                }
                await saveShopData(); // Save the updated shopDataCache to Firestore
                console.log("Shop data (product quantities) updated.");

                if (!isBuyNowFlow) {
                    userCartCache = [];
                    await saveUserCart();
                    updateCartCount();
                }

                hideLoading();
                showMessage('Đơn hàng đã được tạo thành công!', 'success');
                closeModal(orderCreationModal);
                renderOrders('created');
            } catch (error) {
                hideLoading();
                console.error("Error creating order:", error);
                showMessage(`Lỗi khi tạo đơn hàng: ${error.message}`, 'error');
            }
        });

        async function renderOrders(status) {
            const orderListElement = document.getElementById(`${status}-orders-list`);
            orderListElement.innerHTML = '<p class="text-gray-500 italic text-center">Đang tải đơn hàng...</p>';
            showLoading();

            try {
                let orders = [];
                if (loggedInUser && loggedInUser.isAdmin) {
                    // Admin sees all orders from the public adminOrders collection
                    const q = query(collection(db, `artifacts/${appId}/public/data/adminOrders`), where('status', '==', status));
                    const querySnapshot = await getDocs(q);
                    orders = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log(`Admin orders for status ${status}:`, orders);
                } else if (loggedInUser && loggedInUser.id) {
                    // Regular user sees only their own orders
                    const q = query(collection(db, `artifacts/${appId}/users/${loggedInUser.id}/orders`), where('status', '==', status));
                    const querySnapshot = await getDocs(q);
                    orders = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log(`User ${loggedInUser.id} orders for status ${status}:`, orders);
                } else {
                    // No user logged in or anonymous user, cannot fetch user-specific orders
                    orderListElement.innerHTML = '<p class="text-gray-500 italic text-center">Vui lòng đăng nhập để xem đơn hàng của bạn.</p>';
                    hideLoading();
                    return;
                }

                orderListElement.innerHTML = '';
                if (orders.length === 0) {
                    orderListElement.innerHTML = '<p class="text-gray-500 italic text-center">Chưa có đơn hàng nào trong mục này.</p>';
                } else {
                    orders.forEach(order => {
                        const orderCard = document.createElement('div');
                        // Changed bg-white to bg-transparent
                        orderCard.className = 'bg-transparent rounded-xl shadow-lg p-6 mb-4';
                        orderCard.innerHTML = `
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-xl font-bold text-gray-900">Đơn hàng #${order.id}</h4>
                                <span class="text-sm font-medium text-gray-600">Ngày đặt: ${new Date(order.orderDate).toLocaleDateString('vi-VN')}</span>
                            </div>
                            <p class="text-gray-700 mb-2"><strong>Khách hàng:</strong> ${order.customerName} (ID: ${order.userId})</p>
                            <p class="text-gray-700 mb-2"><strong>SĐT:</strong> <span class="blurred-content" id="order-phone-${order.id}">${order.customerPhone}</span> <button type="button" class="toggle-visibility-btn text-blue-500 hover:underline" data-target-id="order-phone-${order.id}"><i class="fas fa-eye"></i></button></p>
                            <p class="text-gray-700 mb-2"><strong>Địa chỉ:</strong> <span class="blurred-content" id="order-address-${order.id}">${order.customerAddress}</span> <button type="button" class="toggle-visibility-btn text-blue-500 hover:underline" data-target-id="order-address-${order.id}"><i class="fas fa-eye"></i></button></p>
                            <p class="text-gray-700 mb-2"><strong>Vị trí kho:</strong> ${order.orderLocation || 'N/A'}</p>
                            <p class="text-gray-700 mb-2"><strong>Ngày dự kiến giao:</strong> ${order.estimatedDeliveryDate || 'N/A'}</p>
                            <p class="text-gray-700 mb-2"><strong>Tổng tiền:</strong> ${formatCurrency(order.totalAmount)}</p>
                            <p class="text-gray-700 mb-2"><strong>VAT (Khách trả):</strong> ${formatCurrency(order.totalVATCustomerPays)} (${order.vatPaymentStatus === 'paid' ? 'Đã thanh toán' : (order.vatPaymentStatus === 'pending_admin' ? 'Admin chờ xác nhận' : 'Chờ xác nhận')})</p>
                            <p class="text-gray-700 mb-2"><strong>VAT (Shop hỗ trợ):</strong> ${formatCurrency(order.totalShopSupportVAT)}</p>
                            <p class="text-gray-700 mb-2"><strong>Gói bảo hành:</strong> ${order.warrantyPackage ? `${order.warrantyPackage.name} (${formatCurrency(order.warrantyPackage.price - (order.warrantyPackage.price * order.warrantyPackage.discount / 100))})` : 'Không có'}</p>
                            <p class="text-gray-700 mb-4"><strong>Trạng thái bảo hành:</strong> ${order.warrantyPackage ? (order.warrantyPaymentStatus === 'paid' ? 'Đã thanh toán' : (order.warrantyPaymentStatus === 'pending_admin' ? 'Admin chờ xác nhận' : 'Chờ xác nhận')) : 'N/A'}</p>
                            ${status === 'shipping' ? `<p class="text-red-600 font-bold mb-2">Thanh toán khi nhận hàng: 0đ</p>` : ''}

                            <div class="order-expandable-content" id="order-items-${order.id}">
                                <h5 class="font-semibold text-gray-800 mb-2">Sản phẩm:</h5>
                                ${(order.items || []).map(item => `
                                    <div class="flex items-center space-x-3 mb-1 text-sm">
                                        <img src="${item.productImage}" onerror="this.onerror=null;this.src='https://placehold.co/40x40/cccccc/333333?text=SP';" class="w-10 h-10 object-cover rounded-md">
                                        <p class="flex-1">${item.productName} ${item.selectedColor ? `(${item.selectedColor.value})` : ''} ${item.selectedStorage ? `(${item.selectedStorage.value})` : ''} x ${item.quantity}</p>
                                        <span class="font-semibold">${formatCurrency((item.priceAtOrder + item.customerVATPortion) * item.quantity)}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <button class="toggle-order-details-btn text-blue-600 hover:underline text-sm mt-2">Xem chi tiết sản phẩm</button>
                            <div class="mt-4 flex flex-wrap gap-2">
                                ${loggedInUser && loggedInUser.isAdmin ? `
                                    ${status === 'created' ? `<button class="admin-approve-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200" data-order-id="${order.id}" data-customer-user-id="${order.userId}" data-target-status="shipping">Phê duyệt (Vận chuyển)</button>` : ''}
                                    ${status === 'shipping' ? `
                                        <button class="admin-approve-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200" data-order-id="${order.id}" data-customer-user-id="${order.userId}" data-target-status="delivered">Phê duyệt (Đã giao)</button>
                                        <button class="admin-edit-shipping-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200" data-order-id="${order.id}">Chi tiết vận chuyển</button>
                                    ` : ''}
                                    <button class="admin-cancel-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200" data-order-id="${order.id}" data-customer-user-id="${order.userId}">Hủy</button>
                                ` : `
                                    ${status === 'created' ? `
                                        <button class="pay-vat-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200" data-order-id="${order.id}">Thanh toán VAT</button>
                                        <button class="add-warranty-btn bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200" data-order-id="${order.id}">Mua gói bảo hành</button>
                                    ` : ''}
                                    ${status === 'shipping' ? `
                                        <button class="track-order-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200" data-order-id="${order.id}">Theo dõi đơn hàng</button>
                                    ` : ''}
                                    ${status === 'delivered' ? `
                                        <button class="return-exchange-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200" data-order-id="${order.id}">Đổi/Trả</button>
                                    ` : ''}
                                `}
                            </div>
                        `;
                        orderListElement.appendChild(orderCard);
                    });

                    document.querySelectorAll('.toggle-visibility-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const targetId = this.dataset.targetId;
                            const targetElement = document.getElementById(targetId);
                            const isBlurred = targetElement.classList.contains('blurred-content');
                            if (isBlurred) {
                                targetElement.classList.remove('blurred-content');
                                this.innerHTML = '<i class="fas fa-eye"></i>';
                            } else {
                                targetElement.classList.add('blurred-content');
                                this.innerHTML = '<i class="fas fa-eye-slash"></i>';
                            }
                        });
                    });

                    document.querySelectorAll('.toggle-order-details-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            // Ensure 'order' is defined in this scope. It's better to get it from the button's parent.
                            const orderId = this.closest('.bg-transparent').querySelector('h4').textContent.replace('Đơn hàng #', '');
                            // Find the order object from the `orders` array
                            const currentOrder = orders.find(o => o.id === orderId);
                            if (currentOrder) {
                                const content = document.getElementById(`order-items-${currentOrder.id}`);
                                if (content) {
                                    content.classList.toggle('expanded');
                                    if (content.classList.contains('expanded')) {
                                        this.textContent = 'Thu gọn chi tiết sản phẩm';
                                    } else {
                                        this.textContent = 'Xem chi tiết sản phẩm';
                                    }
                                }
                            }
                        });
                    });

                    // Admin specific buttons
                    document.querySelectorAll('.admin-approve-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const orderId = e.target.dataset.orderId;
                            const customerUserId = e.target.dataset.customerUserId;
                            const targetStatus = e.target.dataset.targetStatus;
                            await updateOrderStatus(orderId, customerUserId, targetStatus);
                        });
                    });

                    document.querySelectorAll('.admin-cancel-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const orderId = e.target.dataset.orderId;
                            const customerUserId = e.target.dataset.customerUserId;
                            if (confirm('Bạn có chắc chắn muốn hủy đơn hàng này?')) {
                                await deleteOrder(orderId, customerUserId);
                            }
                        });
                    });

                    document.querySelectorAll('.admin-edit-shipping-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const orderId = e.target.dataset.orderId;
                            const order = orders.find(o => o.id === orderId);
                            if (order) {
                                editShippingOrderIdDisplay.textContent = order.id;
                                editShippingOrderHiddenId.value = order.id;
                                editOrderLocationInput.value = order.orderLocation || '';
                                editEstimatedDeliveryDateInput.value = order.estimatedDeliveryDate || '';
                                openModal(editShippingOrderModal);
                            }
                        });
                    });

                    // User specific buttons (existing logic)
                    document.querySelectorAll('.pay-vat-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            if (!loggedInUser || !loggedInUser.id) {
                                showMessage('Vui lòng đăng nhập để thanh toán VAT.', 'info');
                                openModal(loginRegisterModal);
                                return;
                            }
                            const orderId = e.target.dataset.orderId;
                            const order = orders.find(o => o.id === orderId);
                            if (order) {
                                currentOrderForPayment = order;
                                displayPaymentVATModal(order);
                            }
                        });
                    });

                    document.querySelectorAll('.add-warranty-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            if (!loggedInUser || !loggedInUser.id) {
                                showMessage('Vui lòng đăng nhập để mua gói bảo hành.', 'info');
                                openModal(loginRegisterModal);
                                return;
                            }
                            const orderId = e.target.dataset.orderId;
                            const order = orders.find(o => o.id === orderId);
                            if (order) {
                                currentOrderForWarranty = order;
                                displayPaymentWarrantyModal(order);
                            }
                        });
                    });

                    document.querySelectorAll('.track-order-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const orderId = e.target.dataset.orderId;
                            const order = orders.find(o => o.id === orderId);
                            if (order) {
                                currentOrderForTracking = order;
                                displayOrderTrackingModal(order);
                            }
                        });
                    });

                    document.querySelectorAll('.return-exchange-btn').forEach(button => {
                        button.addEventListener('click', () => {
                            showMessage('Chức năng đổi/trả đang được phát triển.', 'info');
                        });
                    });
                }
            } catch (error) {
                console.error("Error rendering orders:", error);
                showMessage(`Lỗi khi tải đơn hàng: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function updateOrderStatus(orderId, customerUserId, newStatus) {
            showLoading();
            try {
                const updates = { status: newStatus };
                if (newStatus === 'shipping') {
                    updates.vatPaymentStatus = 'paid'; // Set VAT status to paid when moving from created to shipping
                    updates.warrantyPaymentStatus = 'paid'; // Set warranty status to paid when moving from created to shipping
                }

                // Update user's order
                const userOrderRef = doc(db, `artifacts/${appId}/users/${customerUserId}/orders`, orderId);
                await updateDoc(userOrderRef, updates);
                console.log(`Order ${orderId} status updated to ${newStatus} in user's collection.`);

                // Update admin's order (if applicable)
                const adminOrderRef = doc(collection(db, `artifacts/${appId}/public/data/adminOrders`), orderId);
                await updateDoc(adminOrderRef, updates);
                console.log(`Order ${orderId} status updated to ${newStatus} in admin collection.`);

                showMessage(`Đơn hàng #${orderId} đã được chuyển sang trạng thái "${newStatus}".`, 'success');
                // Re-render all order sections to reflect changes
                renderOrders('created');
                renderOrders('shipping');
                renderOrders('delivered');
            } catch (error) {
                console.error("Error updating order status:", error);
                showMessage(`Lỗi cập nhật trạng thái đơn hàng: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteOrder(orderId, customerUserId) {
            showLoading();
            try {
                // Delete from user's private collection
                const userOrderRef = doc(db, `artifacts/${appId}/users/${customerUserId}/orders`, orderId);
                await deleteDoc(userOrderRef);
                console.log(`Order ${orderId} deleted from user's collection.`);

                // Delete from admin's public collection
                const adminOrderRef = doc(collection(db, `artifacts/${appId}/public/data/adminOrders`), orderId);
                await deleteDoc(adminOrderRef);
                console.log(`Order ${orderId} deleted from admin collection.`);

                showMessage(`Đơn hàng #${orderId} đã được hủy thành công.`, 'success');
                // Re-render all order sections to reflect changes
                renderOrders('created');
                renderOrders('shipping');
                renderOrders('delivered');
            } catch (error) {
                console.error("Error deleting order:", error);
                showMessage(`Lỗi khi hủy đơn hàng: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        editShippingOrderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!loggedInUser || !loggedInUser.isAdmin) { // Added null check for loggedInUser
                showMessage('Chờ admin kiểm duyệt', 'info');
                return;
            }
            showLoading();
            const orderId = editShippingOrderHiddenId.value;
            const newLocation = editOrderLocationInput.value.trim();
            const newEstimatedDate = editEstimatedDeliveryDateInput.value;

            try {
                // Fetch the order to get the customerUserId
                const adminOrderRef = doc(collection(db, `artifacts/${appId}/public/data/adminOrders`), orderId);
                const adminOrderSnap = await getDoc(adminOrderRef);
                if (!adminOrderSnap.exists()) {
                    showMessage('Không tìm thấy đơn hàng để cập nhật.', 'error');
                    hideLoading();
                    return;
                }
                const orderData = adminOrderSnap.data();
                const customerUserId = orderData.userId; // Get the original user ID

                const userOrderRef = doc(db, `artifacts/${appId}/users/${customerUserId}/orders`, orderId);
                await updateDoc(userOrderRef, {
                    orderLocation: newLocation,
                    estimatedDeliveryDate: newEstimatedDate
                });
                console.log(`Shipping info for order ${orderId} updated in user's collection.`);

                await updateDoc(adminOrderRef, {
                    orderLocation: newLocation,
                    estimatedDeliveryDate: newEstimatedDate
                });
                console.log(`Shipping info for order ${orderId} updated in admin collection.`);

                showMessage('Cập nhật thông tin vận chuyển thành công!', 'success');
                closeModal(editShippingOrderModal);
                renderOrders('shipping');
            } catch (error) {
                console.error("Error updating shipping info:", error);
                showMessage(`Lỗi cập nhật thông tin vận chuyển: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        });

        // Thêm nút sao chép sản phẩm
        function renderProductManagementList() {
            productManagementList.innerHTML = '';
            if (shopDataCache.products.length === 0) {
                productManagementList.innerHTML = '<p class="text-gray-500 italic">Chưa có sản phẩm nào.</p>';
                return;
            }
            shopDataCache.products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'flex items-center justify-between bg-gray-100 p-3 rounded-lg shadow-sm';
                productDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <img src="${product.image}" onerror="this.onerror=null;this.src='https://placehold.co/60x60/cccccc/333333?text=SP';" class="w-16 h-16 object-cover rounded-md">
                        <div>
                            <p class="font-semibold text-gray-900">${product.name}</p>
                            <p class="text-sm text-gray-600">${formatCurrency(product.basePrice)}</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button class="copy-product-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg transition-all duration-200" data-product-id="${product.id}">Sao chép</button>
                        <button class="edit-product-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-3 rounded-lg transition-all duration-200" data-product-id="${product.id}">Sửa</button>
                        <button class="delete-product-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg transition-all duration-200" data-product-id="${product.id}">Xóa</button>
                    </div>
                `;
                productManagementList.appendChild(productDiv);
            });

            document.querySelectorAll('.copy-product-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    if (!loggedInUser || !loggedInUser.isAdmin) {
                        showMessage('Chờ admin kiểm duyệt', 'info');
                        return;
                    }
                    const productId = e.target.dataset.productId;
                    copyProduct(productId);
                });
            });

            document.querySelectorAll('.edit-product-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    if (!loggedInUser || !loggedInUser.isAdmin) {
                        showMessage('Chờ admin kiểm duyệt', 'info');
                        return;
                    }
                    const productId = e.target.dataset.productId;
                    editProduct(productId);
                });
            });

            document.querySelectorAll('.delete-product-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    if (!loggedInUser || !loggedInUser.isAdmin) {
                        showMessage('Chờ admin kiểm duyệt', 'info');
                        return;
                    }
                    const productId = e.target.dataset.productId;
                    if (confirm('Bạn có chắc chắn muốn xóa sản phẩm này?')) {
                        await deleteProduct(productId);
                    }
                });
            });
        }

        function resetAddEditProductForm() {
            addEditProductTitle.textContent = 'Thêm Mặt Hàng Mới';
            editProductIdInput.value = '';
            newProductNameInput.value = '';
            newProductBasePriceInput.value = '';
            newProductImageInput.value = '';
            newProductDescriptionInput.value = '';
            newProductReviewsInput.value = '0';
            colorOptionsContainer.innerHTML = '';
            storageOptionsContainer.innerHTML = '';
            variantsContainer.innerHTML = '';
            submitProductBtn.textContent = 'Thêm Sản Phẩm';
            cancelEditBtn.classList.add('hidden');
        }

        // Cập nhật hàm sao chép sản phẩm
        function copyProduct(productId) {
            const product = shopDataCache.products.find(p => p.id === productId);
            if (!product) {
                showMessage('Không tìm thấy sản phẩm để sao chép.', 'error');
                return;
            }

            // Tạo một bản sao của sản phẩm và gán ID mới
            const copiedProduct = JSON.parse(JSON.stringify(product));
            copiedProduct.id = generateId();
            copiedProduct.name = `Bản sao của ${product.name}`; // Đổi tên để dễ nhận biết

            // Reset số lượng đã bán cho bản sao
            copiedProduct.variants.forEach(variant => {
                variant.sold = 0;
            });

            // Thêm bản sao vào danh sách sản phẩm và hiển thị form chỉnh sửa
            shopDataCache.products.push(copiedProduct);
            showMessage('Đã sao chép sản phẩm. Vui lòng chỉnh sửa và lưu.', 'success');
            editProduct(copiedProduct.id); // Mở form chỉnh sửa với sản phẩm đã sao chép
        }

        addEditProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!loggedInUser || !loggedInUser.isAdmin) { // Added null check for loggedInUser
                showMessage('Chờ admin kiểm duyệt', 'info');
                return;
            }
            showLoading();

            const productId = editProductIdInput.value;
            const name = newProductNameInput.value.trim();
            const basePrice = parseFloat(newProductBasePriceInput.value);
            const image = newProductImageInput.value.trim();
            const description = newProductDescriptionInput.value.trim();
            const reviewsCount = parseInt(newProductReviewsInput.value);

            const colors = [];
            colorOptionsContainer.querySelectorAll('.color-option-item').forEach(item => {
                const name = item.querySelector('input[placeholder="Tên màu"]').value.trim();
                const priceImpact = parseFloat(item.querySelector('input[placeholder="Giá tác động"]').value) || 0;
                const display_image = item.querySelector('input[placeholder="URL ảnh hiển thị"]').value.trim();
                if (name) colors.push({ name, priceImpact, display_image });
            });

            const storages = [];
            storageOptionsContainer.querySelectorAll('.storage-option-item').forEach(item => {
                const name = item.querySelector('input[placeholder="Tên dung lượng"]').value.trim();
                const priceImpact = parseFloat(item.querySelector('input[placeholder="Giá tác động"]').value) || 0;
                if (name) storages.push({ name, priceImpact });
            });

            const variants = [];
            variantsContainer.querySelectorAll('.variant-item').forEach(item => {
                const color = item.querySelector('select[data-type="color-select"]').value;
                const storage = item.querySelector('select[data-type="storage-select"]').value;
                const quantity = parseInt(item.querySelector('input[placeholder="Số lượng"]').value) || 0;
                const sold = parseInt(item.querySelector('input[placeholder="Số lượng đã bán"]').value) || 0; // Lấy giá trị số lượng đã bán
                const priceImpact = parseFloat(item.querySelector('input[placeholder="Giá tác động"]').value) || 0;
                if (color && storage) variants.push({ color, storage, quantity, priceImpact, sold });
            });

            const newProduct = {
                name,
                basePrice,
                image,
                description,
                reviewsCount,
                colors,
                storages,
                variants
            };

            if (productId) {
                // Find and update the product in shopDataCache.products
                const index = shopDataCache.products.findIndex(p => p.id === productId);
                if (index > -1) {
                    shopDataCache.products[index] = { ...shopDataCache.products[index], ...newProduct };
                }
                showMessage('Sản phẩm đã được cập nhật!', 'success');
                console.log(`Product ${productId} updated.`);
            } else {
                // Add new product to shopDataCache.products
                newProduct.id = generateId(); // Assign a new ID for new products
                shopDataCache.products.push(newProduct);
                showMessage('Sản phẩm đã được thêm!', 'success');
                console.log("New product added:", newProduct);
            }
            await saveShopData(); // Save the updated shopDataCache to Firestore
            resetAddEditProductForm();
            hideLoading();
        });

        // Cập nhật hàm editProduct để hiển thị số lượng đã bán
        async function editProduct(productId) {
            const product = shopDataCache.products.find(p => p.id === productId);
            if (!product) {
                showMessage('Không tìm thấy sản phẩm.', 'error');
                return;
            }

            addEditProductTitle.textContent = 'Chỉnh Sửa Sản Phẩm';
            editProductIdInput.value = product.id;
            newProductNameInput.value = product.name;
            newProductBasePriceInput.value = product.basePrice;
            newProductImageInput.value = product.image;
            newProductDescriptionInput.value = product.description;
            newProductReviewsInput.value = product.reviewsCount;

            colorOptionsContainer.innerHTML = '';
            product.colors.forEach(color => addColorOption(color.name, color.priceImpact, color.display_image));

            storageOptionsContainer.innerHTML = '';
            product.storages.forEach(storage => addStorageOption(storage.name, storage.priceImpact));

            variantsContainer.innerHTML = '';
            product.variants.forEach(variant => addVariant(variant.color, variant.storage, variant.quantity, variant.priceImpact, variant.sold));

            submitProductBtn.textContent = 'Lưu Thay Đổi';
            cancelEditBtn.classList.remove('hidden');
        }

        cancelEditBtn.addEventListener('click', resetAddEditProductForm);

        async function deleteProduct(productId) {
            showLoading();
            try {
                shopDataCache.products = shopDataCache.products.filter(p => p.id !== productId);
                await saveShopData(); // Save the updated shopDataCache to Firestore
                showMessage('Sản phẩm đã được xóa!', 'success');
                console.log(`Product ${productId} deleted.`);
            } catch (error) {
                console.error("Error deleting product:", error);
                showMessage(`Lỗi khi xóa sản phẩm: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        addColorOptionBtn.addEventListener('click', () => addColorOption('', 0, ''));
        addStorageOptionBtn.addEventListener('click', () => addStorageOption('', 0));
        addVariantBtn.addEventListener('click', () => addVariant('', '', 0, 0, 0)); // Thêm giá trị mặc định cho sold

        // Cập nhật hàm addVariant để thêm ô số lượng đã bán
        function addVariant(color = '', storage = '', quantity = 0, priceImpact = 0, sold = 0) {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 variant-item';
            const currentColors = Array.from(colorOptionsContainer.querySelectorAll('input[placeholder="Tên màu"]')).map(input => input.value.trim()).filter(Boolean);
            const currentStorages = Array.from(storageOptionsContainer.querySelectorAll('input[placeholder="Tên dung lượng"]')).map(input => input.value.trim()).filter(Boolean);

            const colorSelectHtml = `<select data-type="color-select" class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 flex-1">
                <option value="">Chọn màu</option>
                ${currentColors.map(c => `<option value="${c}" ${c === color ? 'selected' : ''}>${c}</option>`).join('')}
            </select>`;
            const storageSelectHtml = `<select data-type="storage-select" class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 flex-1">
                <option value="">Chọn dung lượng</option>
                ${currentStorages.map(s => `<option value="${s}" ${s === storage ? 'selected' : ''}>${s}</option>`).join('')}
            </select>`;

            div.innerHTML = `
                ${colorSelectHtml}
                ${storageSelectHtml}
                <input type="number" placeholder="Số lượng" value="${quantity}" class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 w-24">
                <input type="number" placeholder="Số lượng đã bán" value="${sold}" class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 w-32">
                <input type="number" placeholder="Giá tác động" value="${priceImpact}" class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 w-32">
                <button type="button" class="remove-option-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg"><i class="fas fa-minus"></i></button>
            `;
            variantsContainer.appendChild(div);
            div.querySelector('.remove-option-btn').addEventListener('click', () => div.remove());
        }

        function addColorOption(name = '', priceImpact = 0, display_image = '') {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 color-option-item';
            div.innerHTML = `
                <input type="text" placeholder="Tên màu" value="${name}" class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 flex-1">
                <input type="number" placeholder="Giá tác động" value="${priceImpact}" class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 w-32">
                <input type="url" placeholder="URL ảnh hiển thị" value="${display_image}" class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 flex-1">
                <button type="button" class="remove-option-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg"><i class="fas fa-minus"></i></button>
            `;
            colorOptionsContainer.appendChild(div);
            div.querySelector('.remove-option-btn').addEventListener('click', () => div.remove());
        }

        function addStorageOption(name = '', priceImpact = 0) {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 storage-option-item';
            div.innerHTML = `
                <input type="text" placeholder="Tên dung lượng" value="${name}" class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 flex-1">
                <input type="number" placeholder="Giá tác động" value="${priceImpact}" class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 w-32">
                <button type="button" class="remove-option-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg"><i class="fas fa-minus"></i></button>
            `;
            storageOptionsContainer.appendChild(div);
            div.querySelector('.remove-option-btn').addEventListener('click', () => div.remove());
        }

        async function renderVouchersList() {
            currentVouchersList.innerHTML = '';
            const vouchers = Object.entries(shopDataCache.vouchers);
            if (vouchers.length === 0) {
                currentVouchersList.innerHTML = '<p class="text-gray-500 italic">Chưa có voucher nào.</p>';
                return;
            }
            vouchers.forEach(([code, value]) => {
                const voucherDiv = document.createElement('div');
                voucherDiv.className = 'flex items-center justify-between bg-gray-100 p-3 rounded-lg shadow-sm';
                voucherDiv.innerHTML = `
                    <p class="font-semibold text-gray-900">${code}: ${typeof value === 'number' && value < 1 ? `${value * 100}%` : (typeof value === 'number' ? formatCurrency(value) : value)}</p>
                    <button class="delete-voucher-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg transition-all duration-200" data-voucher-code="${code}">Xóa</button>
                `;
                currentVouchersList.appendChild(voucherDiv);
            });

            document.querySelectorAll('.delete-voucher-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    if (!loggedInUser || !loggedInUser.isAdmin) { // Added null check for loggedInUser
                        showMessage('Chờ admin kiểm duyệt', 'info');
                        return;
                    }
                    const voucherCode = e.target.dataset.voucherCode;
                    if (confirm('Bạn có chắc chắn muốn xóa voucher này?')) {
                        await deleteVoucher(voucherCode);
                    }
                });
            });
        }

        addVoucherForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!loggedInUser || !loggedInUser.isAdmin) { // Added null check for loggedInUser
                showMessage('Chờ admin kiểm duyệt', 'info');
                return;
            }
            showLoading();
            const code = newVoucherCodeInput.value.trim().toUpperCase();
            let value = newVoucherValueInput.value.trim();

            if (value.toLowerCase() === 'freeship') {
                value = 'freeship';
            } else {
                value = parseFloat(value);
                if (isNaN(value)) {
                    showMessage('Giá trị voucher không hợp lệ.', 'error');
                    hideLoading();
                    return;
                }
            }

            shopDataCache.vouchers[code] = value;
            await saveShopData();
            renderVouchersList();
            newVoucherCodeInput.value = '';
            newVoucherValueInput.value = '';
            hideLoading();
        });

        async function deleteVoucher(code) {
            showLoading();
            try {
                delete shopDataCache.vouchers[code];
                await saveShopData();
                renderVouchersList();
                console.log(`Voucher ${code} deleted.`);
            } catch (error) {
                console.error("Error deleting voucher:", error);
                showMessage(`Lỗi khi xóa voucher: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function renderWarrantyPackagesList() {
            currentWarrantyPackagesList.innerHTML = '';
            if (shopDataCache.warrantyPackages.length === 0) {
                currentWarrantyPackagesList.innerHTML = '<p class="text-gray-500 italic">Chưa có gói bảo hành nào được cấu hình.</p>';
                return;
            }
            shopDataCache.warrantyPackages.forEach(pkg => {
                const packageDiv = document.createElement('div');
                packageDiv.className = 'flex items-center justify-between bg-gray-100 p-3 rounded-lg shadow-sm';
                packageDiv.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-900">${pkg.name}</p>
                        <p class="text-sm text-gray-600">Giá: ${formatCurrency(pkg.price)} - Giảm: ${pkg.discount}%</p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="edit-warranty-package-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-3 rounded-lg transition-all duration-200" data-package-id="${pkg.id}">Sửa</button>
                        <button class="delete-warranty-package-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg transition-all duration-200" data-package-id="${pkg.id}">Xóa</button>
                    </div>
                `;
                currentWarrantyPackagesList.appendChild(packageDiv);
            });

            document.querySelectorAll('.edit-warranty-package-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    if (!loggedInUser || !loggedInUser.isAdmin) { // Added null check for loggedInUser
                        showMessage('Chờ admin kiểm duyệt', 'info');
                        return;
                    }
                    const packageId = e.target.dataset.packageId;
                    editWarrantyPackage(packageId);
                });
            });

            document.querySelectorAll('.delete-warranty-package-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    if (!loggedInUser || !loggedInUser.isAdmin) { // Added null check for loggedInUser
                        showMessage('Chờ admin kiểm duyệt', 'info');
                        return;
                    }
                    const packageId = e.target.dataset.packageId;
                    if (confirm('Bạn có chắc chắn muốn xóa gói bảo hành này?')) {
                        await deleteWarrantyPackage(packageId);
                    }
                });
            });
        }

        function resetAddEditWarrantyPackageForm() {
            editWarrantyPackageIdInput.value = '';
            newWarrantyPackageNameInput.value = '';
            newWarrantyPackagePriceInput.value = '';
            newWarrantyPackageDiscountInput.value = '0';
            submitWarrantyPackageBtn.textContent = 'Thêm Gói Bảo Hành';
            cancelEditWarrantyPackageBtn.classList.add('hidden');
        }

        addEditWarrantyPackageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!loggedInUser || !loggedInUser.isAdmin) { // Added null check for loggedInUser
                showMessage('Chờ admin kiểm duyệt', 'info');
                return;
            }
            showLoading();

            const packageId = editWarrantyPackageIdInput.value;
            const name = newWarrantyPackageNameInput.value.trim();
            const price = parseFloat(newWarrantyPackagePriceInput.value);
            const discount = parseFloat(newWarrantyPackageDiscountInput.value);

            const newPackage = {
                id: packageId || generateId(),
                name,
                price,
                discount
            };

            if (packageId) {
                const index = shopDataCache.warrantyPackages.findIndex(p => p.id === packageId);
                if (index > -1) {
                    shopDataCache.warrantyPackages[index] = newPackage;
                }
                showMessage('Gói bảo hành đã được cập nhật!', 'success');
                console.log(`Warranty package ${packageId} updated.`);
            } else {
                shopDataCache.warrantyPackages.push(newPackage);
                showMessage('Gói bảo hành đã được thêm!', 'success');
                console.log("New warranty package added:", newPackage);
            }
            await saveShopData();
            renderWarrantyPackagesList();
            resetAddEditWarrantyPackageForm();
            hideLoading();
        });

        function editWarrantyPackage(packageId) {
            const pkg = shopDataCache.warrantyPackages.find(p => p.id === packageId);
            if (!pkg) {
                showMessage('Không tìm thấy gói bảo hành.', 'error');
                return;
            }
            editWarrantyPackageIdInput.value = pkg.id;
            newWarrantyPackageNameInput.value = pkg.name;
            newWarrantyPackagePriceInput.value = pkg.price;
            newWarrantyPackageDiscountInput.value = pkg.discount;
            submitWarrantyPackageBtn.textContent = 'Lưu Thay Đổi';
            cancelEditWarrantyPackageBtn.classList.remove('hidden');
        }

        cancelEditWarrantyPackageBtn.addEventListener('click', resetAddEditWarrantyPackageForm);

        async function deleteWarrantyPackage(packageId) {
            showLoading();
            try {
                shopDataCache.warrantyPackages = shopDataCache.warrantyPackages.filter(p => p.id !== packageId);
                await saveShopData();
                renderWarrantyPackagesList();
                console.log(`Warranty package ${packageId} deleted.`);
            }
            catch (error) {
                console.error("Error deleting warranty package:", error);
                showMessage(`Lỗi khi xóa gói bảo hành: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function generateShopReport() {
            showLoading();
            let allOrders = [];
            try {
                if (loggedInUser && loggedInUser.isAdmin) { // Added null check for loggedInUser
                    // Corrected Firestore path for adminOrders
                    const querySnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/adminOrders`));
                    allOrders = querySnapshot.docs.map(doc => doc.data());
                    console.log("Admin fetched all orders for report:", allOrders);
                } else if (loggedInUser && loggedInUser.id) { // User is logged in but not admin
                    const querySnapshot = await getDocs(collection(db, `artifacts/${appId}/users/${loggedInUser.id}/orders`));
                    allOrders = querySnapshot.docs.map(doc => doc.data());
                    console.log(`User ${loggedInUser.id} fetched orders for report:`, allOrders);
                } else {
                    // No user logged in or anonymous user, cannot fetch user-specific orders for report
                    totalRevenueDisplay.textContent = formatCurrency(0);
                    totalOrdersDisplay.textContent = 0;
                    topSellingProductsList.innerHTML = '<li class="italic text-gray-500">Vui lòng đăng nhập để xem báo cáo.</li>';
                    hideLoading();
                    return;
                }

                const startDate = reportStartDateInput.value ? new Date(reportStartDateInput.value) : null;
                const endDate = reportEndDateInput.value ? new Date(reportEndDateInput.value) : null;

                const filteredOrders = allOrders.filter(order => {
                    const orderDate = new Date(order.orderDate);
                    return (!startDate || orderDate >= startDate) && (!endDate || orderDate <= endDate);
                });

                let totalRevenue = 0;
                const productSales = {};

                filteredOrders.forEach(order => {
                    totalRevenue += order.totalAmount;
                    order.items.forEach(item => {
                        const productName = item.productName;
                        productSales[productName] = (productSales[productName] || 0) + item.quantity;
                    });
                });

                totalRevenueDisplay.textContent = formatCurrency(totalRevenue);
                totalOrdersDisplay.textContent = filteredOrders.length;

                const sortedProducts = Object.entries(productSales).sort(([, a], [, b]) => b - a);
                topSellingProductsList.innerHTML = '';
                if (sortedProducts.length === 0) {
                    topSellingProductsList.innerHTML = '<li class="italic text-gray-500">Chưa có dữ liệu.</li>';
                } else {
                    sortedProducts.slice(0, 5).forEach(([productName, quantity]) => {
                        const li = document.createElement('li');
                        li.textContent = `${productName}: ${quantity} sản phẩm`;
                        topSellingProductsList.appendChild(li);
                    });
                }
            } catch (error) {
                console.error("Error generating shop report:", error);
                showMessage(`Lỗi khi tạo báo cáo: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        generateReportBtn.addEventListener('click', generateShopReport);

        function displayPaymentVATModal(order) {
            qrCodeDisplay.src = shopDataCache.bankDetails.qrCodeImage || 'https://placehold.co/200x200/cccccc/333333?text=QR+Code';
            bankNameDisplay.textContent = shopDataCache.bankDetails.bankName || 'N/A';
            accountNumberDisplay.textContent = shopDataCache.bankDetails.accountNumber || 'N/A';
            accountHolderDisplay.textContent = shopDataCache.bankDetails.accountHolder || 'N/A';

            // Display values from the order object
            vatBaseAmountDisplay.textContent = formatCurrency(order.totalOriginalProductPrice); // Giá đơn hàng (chưa VAT)
            
            // Shop hỗ trợ thanh toán (8% của tổng giá gốc)
            const shopSupportAmount = order.totalOriginalProductPrice * 0.08; 
            console.log("Order totalOriginalProductPrice:", order.totalOriginalProductPrice);
            console.log("Calculated shopSupportAmount (8%):", shopSupportAmount);
            if (shopSupportVatDisplay) { 
                shopSupportVatDisplay.textContent = formatCurrency(shopSupportAmount);
                console.log("shopSupportVatDisplay element found and updated.");
            } else {
                console.error("shopSupportVatDisplay element not found!");
            }

            // Tổng tiền VAT (10% của tổng giá gốc)
            const totalVATOriginalAmount = order.totalOriginalProductPrice * 0.10;
            console.log("Calculated totalVATOriginalAmount (10%):", totalVATOriginalAmount);
            if (totalVatOriginalDisplay) { 
                totalVatOriginalDisplay.textContent = formatCurrency(totalVATOriginalAmount);
            } else {
                console.error("totalVatOriginalDisplay element not found!");
            }

            // Khách hàng thanh toán (2% của tổng giá gốc)
            const customerPaysAmount = order.totalOriginalProductPrice * 0.02;
            console.log("Calculated customerPaysAmount (2%):", customerPaysAmount);
            paymentModalVATTotal.textContent = formatCurrency(customerPaysAmount); 

            paymentAmountInput.value = customerPaysAmount;
            amountPaidDisplay.textContent = formatCurrency(0);
            remainingPaymentDisplay.textContent = formatCurrency(customerPaysAmount);

            paymentAmountInput.oninput = () => {
                const paidAmount = parseFloat(paymentAmountInput.value) || 0;
                const remaining = customerPaysAmount - paidAmount;
                amountPaidDisplay.textContent = formatCurrency(paidAmount);
                remainingPaymentDisplay.textContent = formatCurrency(remaining);
                remainingPaymentDisplay.style.color = remaining <= 0 ? '#28a745' : '#e53e3e';
            };

            if (loggedInUser && loggedInUser.isAdmin) { // Added null check for loggedInUser
                confirmPaymentBtn.classList.add('hidden');
                adminConfirmVatPaymentBtn.classList.remove('hidden');
            } else {
                confirmPaymentBtn.classList.remove('hidden');
                adminConfirmVatPaymentBtn.classList.add('hidden');
            }

            openModal(paymentVATModal);
        }

        confirmPaymentBtn.addEventListener('click', async () => {
            if (!loggedInUser || !loggedInUser.id) { // Check if user is truly not logged in (id is null for guest)
                showMessage('Vui lòng đăng nhập để thanh toán.', 'info');
                openModal(loginRegisterModal); // Show login modal
                return;
            }
            if (loggedInUser && loggedInUser.isAdmin) { // Added null check for loggedInUser
                showMessage('Admin không cần thực hiện thanh toán này, vui lòng dùng nút "Admin Xác Nhận".', 'info');
                return;
            }
            showLoading();
            try {
                const orderId = currentOrderForPayment.id;
                const orderRef = doc(db, `artifacts/${appId}/users/${loggedInUser.id}/orders`, orderId);
                await updateDoc(orderRef, { vatPaymentStatus: 'pending_admin' });
                console.log(`VAT payment for order ${orderId} set to pending_admin for user.`);

                // Admin's order also needs to be updated if it exists
                // Corrected Firestore path for adminOrders
                const adminOrderRef = doc(collection(db, `artifacts/${appId}/public/data/adminOrders`), orderId);
                const adminOrderSnap = await getDoc(adminOrderRef);
                if (adminOrderSnap.exists()) {
                    await updateDoc(adminOrderRef, { vatPaymentStatus: 'pending_admin' });
                    console.log(`VAT payment for order ${orderId} set to pending_admin for admin.`);
                }


                showMessage('Yêu cầu thanh toán VAT của bạn đang chờ admin xác nhận!', 'info');
                closeModal(paymentVATModal);
                renderOrders(currentOrderForPayment.status);
            } catch (error) {
                console.error("Error confirming VAT payment:", error);
                showMessage(`Lỗi khi xác nhận thanh toán VAT: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        });

        adminConfirmVatPaymentBtn.addEventListener('click', async () => {
            if (!loggedInUser || !loggedInUser.isAdmin) { // Added null check for loggedInUser
                showMessage('Bạn không có quyền xác nhận thanh toán này.', 'error');
                return;
            }
            showLoading();
            try {
                const orderId = currentOrderForPayment.id;
                // Update user's order
                const orderRef = doc(db, `artifacts/${appId}/users/${currentOrderForPayment.userId}/orders`, orderId);
                await updateDoc(orderRef, { vatPaymentStatus: 'paid' });
                console.log(`VAT payment for order ${orderId} set to paid for user.`);

                // Update admin's order
                // Corrected Firestore path for adminOrders
                const adminOrderRef = doc(collection(db, `artifacts/${appId}/public/data/adminOrders`), orderId);
                await updateDoc(adminOrderRef, { vatPaymentStatus: 'paid' });
                console.log(`VAT payment for order ${orderId} set to paid for admin.`);

                showMessage(`Đã xác nhận thanh toán VAT cho đơn hàng #${orderId}.`, 'success');
                closeModal(paymentVATModal);
                renderOrders(currentOrderForPayment.status);
            } catch (error) {
                console.error("Error admin confirming VAT payment:", error);
                showMessage(`Lỗi khi admin xác nhận thanh toán VAT: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        });

        function displayOrderTrackingModal(order) {
            trackingShippingUnitImage.src = shopDataCache.shippingUnit.image || 'https://placehold.co/200x100/cccccc/333333?text=Shipping+Unit';
            trackingShippingUnitName.textContent = shopDataCache.shippingUnit.name || 'N/A';
            trackingOrderId.textContent = order.id;
            trackingCurrentLocation.textContent = order.orderLocation || 'Đang cập nhật';
            trackingDestination.textContent = order.customerAddress || 'N/A';

            trackingProductDetails.innerHTML = (order.items || []).map(item => `
                <div class="flex items-center space-x-2 text-sm">
                    <img src="${item.productImage}" onerror="this.onerror=null;this.src='https://placehold.co/30x30/cccccc/333333?text=SP';" class="w-8 h-8 object-cover rounded-md">
                    <p>${item.productName} x ${item.quantity}</p>
                </div>
            `).join('');

            checkRouteBtn.onclick = () => {
                const shopAddress = shopDataCache.address || DEFAULT_WAREHOUSE_ADDRESS; // Use default if shop address is not set
                const customerAddress = order.customerAddress;
                const encodedShopAddress = encodeURIComponent(shopAddress);
                const encodedCustomerAddress = encodeURIComponent(customerAddress);
                window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodedShopAddress}&destination=${encodedCustomerAddress}`, '_blank');
            };

            openModal(orderTrackingModal);
        }

        function displayPaymentWarrantyModal(order) {
            warrantyPackagesSelection.innerHTML = '';
            selectedWarrantyPackage = null;

            if (shopDataCache.warrantyPackages.length === 0) {
                warrantyPackagesSelection.innerHTML = '<p class="text-gray-500 italic">Chưa có gói bảo hành nào được cấu hình.</p>';
                confirmWarrantyPaymentBtn.disabled = true;
            } else {
                shopDataCache.warrantyPackages.forEach(pkg => {
                    const finalPrice = pkg.price - (pkg.price * pkg.discount / 100);
                    const packageCard = document.createElement('div');
                    packageCard.className = 'warranty-package-card cursor-pointer';
                    packageCard.dataset.packageId = pkg.id;
                    packageCard.innerHTML = `
                        <h4 class="font-bold text-lg text-gray-900">${pkg.name}</h4>
                        <p class="text-gray-700">Giá gốc: <span class="line-through">${formatCurrency(pkg.price)}</span></p>
                        <p class="text-green-600 font-bold text-xl">Giá ưu đãi: ${formatCurrency(finalPrice)} (${pkg.discount}% off)</p>
                    `;
                    warrantyPackagesSelection.appendChild(packageCard);

                    packageCard.addEventListener('click', () => {
                        document.querySelectorAll('.warranty-package-card').forEach(card => card.classList.remove('selected-package'));
                        packageCard.classList.add('selected-package');
                        selectedWarrantyPackage = pkg;
                        warrantyPaymentTotal.textContent = formatCurrency(finalPrice);
                        confirmWarrantyPaymentBtn.disabled = false;
                    });
                });
                confirmWarrantyPaymentBtn.disabled = true;
            }

            qrCodeDisplayWarranty.src = shopDataCache.bankDetails.qrCodeImage || 'https://placehold.co/200x200/cccccc/333333?text=QR+Code';
            bankNameDisplayWarranty.textContent = shopDataCache.bankDetails.bankName || 'N/A';
            accountNumberDisplayWarranty.textContent = shopDataCache.bankDetails.accountNumber || 'N/A';
            accountHolderDisplayWarranty.textContent = shopDataCache.bankDetails.accountHolder || 'N/A';
            warrantyPaymentTotal.textContent = formatCurrency(0);

            if (loggedInUser && loggedInUser.isAdmin) { // Added null check for loggedInUser
                confirmWarrantyPaymentBtn.classList.add('hidden');
                adminConfirmWarrantyBtn.classList.remove('hidden');
            } else {
                confirmWarrantyPaymentBtn.classList.remove('hidden');
                adminConfirmWarrantyBtn.classList.add('hidden');
            }

            openModal(paymentWarrantyModal);
        }

        confirmWarrantyPaymentBtn.addEventListener('click', async () => {
            if (!loggedInUser || !loggedInUser.id) { // Check if user is truly not logged in (id is null for guest)
                showMessage('Vui lòng đăng nhập để thanh toán.', 'info');
                openModal(loginRegisterModal); // Show login modal
                return;
            }
            if (loggedInUser && loggedInUser.isAdmin) { // Added null check for loggedInUser
                showMessage('Admin không cần thực hiện thanh toán này, vui lòng dùng nút "Admin Xác Nhận".', 'info');
                return;
            }
            if (!selectedWarrantyPackage) {
                showMessage('Vui lòng chọn một gói bảo hành.', 'error');
                return;
            }
            showLoading();
            try {
                const orderId = currentOrderForWarranty.id;
                const orderRef = doc(db, `artifacts/${appId}/users/${loggedInUser.id}/orders`, orderId);
                await updateDoc(orderRef, {
                    warrantyPackage: selectedWarrantyPackage,
                    warrantyPaymentStatus: 'pending_admin'
                });
                console.log(`Warranty package for order ${orderId} set to pending_admin for user.`);

                // Corrected Firestore path for adminOrders
                const adminOrderRef = doc(collection(db, `artifacts/${appId}/public/data/adminOrders`), orderId);
                const adminOrderSnap = await getDoc(adminOrderRef);
                if (adminOrderSnap.exists()) {
                    await updateDoc(adminOrderRef, {
                        warrantyPackage: selectedWarrantyPackage,
                        warrantyPaymentStatus: 'pending_admin'
                    });
                    console.log(`Warranty package for order ${orderId} set to pending_admin for admin.`);
                }

                showMessage(`Yêu cầu mua gói bảo hành "${selectedWarrantyPackage.name}" cho đơn hàng #${orderId} đang chờ admin xác nhận.`, 'info');
                closeModal(paymentWarrantyModal);
                renderOrders(currentOrderForWarranty.status);
            } catch (error) {
                console.error("Error adding warranty package:", error);
                showMessage(`Lỗi khi thêm gói bảo hành: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        });

        adminConfirmWarrantyBtn.addEventListener('click', async () => {
            if (!loggedInUser || !loggedInUser.isAdmin) { // Added null check for loggedInUser
                showMessage('Bạn không có quyền xác nhận thanh toán này.', 'error');
                return;
            }
            showLoading();
            try {
                const orderId = currentOrderForWarranty.id;
                // Update user's order
                const orderRef = doc(db, `artifacts/${appId}/users/${currentOrderForWarranty.userId}/orders`, orderId);
                await updateDoc(orderRef, { warrantyPaymentStatus: 'paid' });
                console.log(`Warranty package for order ${orderId} set to paid for user.`);

                // Update admin's order
                // Corrected Firestore path for adminOrders
                const adminOrderRef = doc(collection(db, `artifacts/${appId}/public/data/adminOrders`), orderId);
                await updateDoc(adminOrderRef, { warrantyPaymentStatus: 'paid' });
                console.log(`Warranty package for order ${orderId} set to paid for admin.`);

                showMessage(`Đã xác nhận gói bảo hành cho đơn hàng #${currentOrderForWarranty.id}.`, 'success');
                closeModal(paymentWarrantyModal);
                renderOrders(currentOrderForWarranty.status);
            } catch (error) {
                console.error("Error admin confirming warranty:", error);
                showMessage(`Lỗi khi admin xác nhận gói bảo hành: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        });

        // Authentication and User Management
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("User authenticated:", user.uid);
                const userProfileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}`);
                try {
                    const userDocSnap = await getDoc(userProfileDocRef);
                    if (userDocSnap.exists()) {
                        loggedInUser = { id: currentUserId, ...userDocSnap.data() };
                        // Ensure isAdmin is explicitly set based on email, even if not in Firestore doc
                        loggedInUser.isAdmin = (loggedInUser.email === ADMIN_EMAIL);
                        console.log("Logged in user data:", loggedInUser);
                    } else {
                        // If user profile doesn't exist, create a basic one
                        const isUserAdmin = (user.email === ADMIN_EMAIL);
                        loggedInUser = {
                            id: currentUserId,
                            username: user.email || `guest_${currentUserId.substring(0, 8)}`,
                            fullname: '',
                            phone: '',
                            province: '',
                            isAdmin: isUserAdmin,
                            email: user.email
                        };
                        await setDoc(userProfileDocRef, loggedInUser); // Save the new profile
                        console.log("New user profile created:", loggedInUser);
                    }

                    // Listen to orders based on user type
                    if (!loggedInUser.isAdmin) {
                        onSnapshot(collection(db, `artifacts/${appId}/users/${currentUserId}/orders`), (snapshot) => {
                            userOrdersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            console.log("User orders updated:", userOrdersCache);
                            if (loggedInUser) {
                                renderOrders('created');
                                renderOrders('shipping');
                                renderOrders('delivered');
                            }
                        }, (error) => console.error("Error fetching user orders:", error));

                        onSnapshot(doc(collection(db, `artifacts/${appId}/users/${currentUserId}/cart`), 'currentCart'), (docSnapshot) => {
                            if (docSnapshot.exists()) {
                                userCartCache = docSnapshot.data().items || [];
                            } else {
                                userCartCache = [];
                            }
                            console.log("User cart updated:", userCartCache);
                            updateCartCount();
                            if (cartModal.classList.contains('active')) {
                                renderCart();
                            }
                        }, (error) => console.error("Error fetching user cart:", error));
                    } else {
                        // Admin listens to the public adminOrders collection
                        onSnapshot(collection(db, `artifacts/${appId}/public/data/adminOrders`), (snapshot) => {
                            userOrdersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            console.log("Admin orders updated:", userOrdersCache);
                            if (loggedInUser) {
                                renderOrders('created');
                                renderOrders('shipping');
                                renderOrders('delivered');
                            }
                        }, (error) => console.error("Error fetching admin orders:", error));
                    }
                } catch (error) {
                    console.error("Error during user profile fetching/creation:", error);
                    showMessage(`Lỗi tải hồ sơ người dùng: ${error.message}`, 'error');
                }
            } else {
                // If no user is logged in, initialize loggedInUser as an anonymous/guest object
                loggedInUser = { id: null, username: 'Khách', isAdmin: false, email: null, fullname: '', phone: '', province: '' };
                currentUserId = null;
                userOrdersCache = [];
                userCartCache = [];
                console.log("User logged out.");
            }
            updateAuthUI();
        });

        function updateAuthUI() {
            // Ensure loggedInUser is not null before accessing its properties
            if (loggedInUser && loggedInUser.id) { // Check if user is truly logged in (id is not null for authenticated users)
                loginStatusBtn.textContent = `Xin chào, ${loggedInUser.username || loggedInUser.email || 'Khách'}`;
                loginStatusBtn.onclick = logoutUser;
                openManagementModalBtn.style.display = loggedInUser.isAdmin ? 'block' : 'none';
                openSettingsModalBtn.style.display = loggedInUser.isAdmin ? 'block' : 'none';
                openShopAnalyticsModalBtn.style.display = loggedInUser.isAdmin ? 'block' : 'none';
            } else {
                loginStatusBtn.textContent = 'Đăng nhập';
                loginStatusBtn.onclick = () => openModal(loginRegisterModal);
                openManagementModalBtn.style.display = 'none';
                openSettingsModalBtn.style.display = 'none';
                openShopAnalyticsModalBtn.style.display = 'none';
            }
        }

        loginStatusBtn.addEventListener('click', () => {
            if (!loggedInUser || !loggedInUser.id) { // Check if user is truly not logged in (id is null for guest)
                openModal(loginRegisterModal);
            } else {
                logoutUser();
            }
        });

        showRegisterFormLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            authModalTitle.textContent = 'Đăng ký';
            loginErrorMessage.classList.add('hidden');
            registerErrorMessage.classList.add('hidden');
        });

        showLoginFormLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            authModalTitle.textContent = 'Đăng nhập';
            loginErrorMessage.classList.add('hidden');
            registerErrorMessage.classList.add('hidden');
        });

        registerSubmitBtn.addEventListener('click', async () => {
            const email = registerUsernameInput.value.trim();
            const password = registerPasswordInput.value.trim();
            const confirmPassword = registerConfirmPasswordInput.value.trim();
            const fullname = registerFullnameInput.value.trim();
            const phone = registerPhoneInput.value.trim();
            const province = registerProvinceInput.value.trim();

            if (!email || !password || !confirmPassword || !fullname || !phone || !province) {
                registerErrorMessage.textContent = 'Vui lòng điền đầy đủ thông tin.';
                registerErrorMessage.classList.remove('hidden');
                return;
            }
            if (password !== confirmPassword) {
                registerErrorMessage.textContent = 'Mật khẩu và xác nhận mật khẩu không khớp.';
                registerErrorMessage.classList.remove('hidden');
                return;
            }

            showLoading();
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const isUserAdmin = (email === ADMIN_EMAIL);

                await setDoc(doc(db, `artifacts/${appId}/users/${user.uid}`), {
                    username: email,
                    fullname,
                    phone,
                    province,
                    isAdmin: isUserAdmin,
                    email: email // Store email in user profile
                });
                console.log("User registered and profile created:", user.uid);

                showMessage('Đăng ký thành công! Vui lòng đăng nhập.', 'success');
                registerErrorMessage.classList.add('hidden');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                authModalTitle.textContent = 'Đăng nhập';
                loginUsernameInput.value = email;
                loginPasswordInput.value = '';
            } catch (error) {
                console.error("Error during registration:", error);
                registerErrorMessage.textContent = `Lỗi đăng ký: ${error.message}`;
                registerErrorMessage.classList.remove('hidden');
            } finally {
                hideLoading();
            }
        });

        loginSubmitBtn.addEventListener('click', async () => {
            const email = loginUsernameInput.value.trim();
            const password = loginPasswordInput.value.trim();

            if (!email || !password) {
                loginErrorMessage.textContent = 'Vui lòng nhập email và mật khẩu.';
                loginErrorMessage.classList.remove('hidden');
                return;
            }

            showLoading();
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage('Đăng nhập thành công!', 'success');
                loginErrorMessage.classList.add('hidden');
                closeModal(loginRegisterModal);
            } catch (error) {
                console.error("Error during login:", error);
                loginErrorMessage.textContent = `Lỗi đăng nhập: ${error.message}`;
                loginErrorMessage.classList.remove('hidden');
            } finally {
                hideLoading();
            }
        });

        async function logoutUser() {
            showLoading();
            try {
                await signOut(auth);
                showMessage('Đã đăng xuất.', 'info');
                // No anonymous sign-in after logout as per new requirement
            } catch (error) {
                console.error("Error during logout:", error);
                showMessage(`Lỗi đăng xuất: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function renderProfileModal() {
            if (loggedInUser) {
                profileUsernameInput.value = loggedInUser.username || '';
                profileFullnameInput.value = loggedInUser.fullname || '';
                profilePhoneInput.value = loggedInUser.phone || '';
                profileProvinceInput.value = loggedInUser.province || '';
            }
        }

        saveProfileBtn.addEventListener('click', async () => {
            if (!loggedInUser || !loggedInUser.id) { // Check if user is truly not logged in (id is null for guest)
                showMessage('Vui lòng đăng nhập để lưu hồ sơ.', 'info');
                openModal(loginRegisterModal); // Show login modal
                return;
            }
            showLoading();
            try {
                const profileRef = doc(db, `artifacts/${appId}/users/${loggedInUser.id}`);
                await updateDoc(profileRef, {
                    fullname: profileFullnameInput.value.trim(),
                    phone: profilePhoneInput.value.trim(),
                    province: profileProvinceInput.value.trim()
                });
                loggedInUser.fullname = profileFullnameInput.value.trim();
                loggedInUser.phone = profilePhoneInput.value.trim();
                loggedInUser.province = profileProvinceInput.value.trim();
                showMessage('Hồ sơ đã được cập nhật!', 'success');
                console.log("User profile updated.");
            } catch (error) {
                console.error("Error updating user profile:", error);
                profileErrorMessage.textContent = `Lỗi cập nhật hồ sơ: ${error.message}`;
                profileErrorMessage.classList.remove('hidden');
            } finally {
                hideLoading();
            }
        });

        async function saveUserCart() {
            if (loggedInUser && currentUserId) {
                showLoading();
                try {
                    await setDoc(doc(collection(db, `artifacts/${appId}/users/${currentUserId}/cart`), 'currentCart'), { items: userCartCache });
                    console.log("User cart saved.");
                } catch (error) {
                    console.error("Error saving cart:", error);
                    showMessage("Lỗi lưu giỏ hàng.", "error");
                } finally {
                    hideLoading();
                }
            }
        }

        async function updateCartCount() {
            if (loggedInUser && currentUserId) {
                try {
                    const cartDocSnap = await getDoc(doc(collection(db, `artifacts/${appId}/users/${currentUserId}/cart`), 'currentCart'));
                    if (cartDocSnap.exists()) {
                        userCartCache = cartDocSnap.data().items || [];
                        const totalItems = userCartCache.reduce((sum, item) => sum + item.quantity, 0);
                        cartCountSpan.textContent = totalItems;
                    } else {
                        userCartCache = [];
                        cartCountSpan.textContent = 0;
                    }
                } catch (error) {
                    console.error("Error updating cart count:", error);
                    cartCountSpan.textContent = 0;
                }
            } else {
                cartCountSpan.textContent = 0;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // No automatic sign-in on page load.
            // Instead, just load shop data and display products.
            loadShopData();
            showSection('product-list-section', showProductsBtn);
            updateAuthUI(); // Initialize UI based on current (logged out) state
        });

        document.getElementById('open-address-in-map-btn').addEventListener('click', () => {
            const address = shopDataCache.address;
            if (address && address !== 'Chưa cập nhật') {
                const encodedAddress = encodeURIComponent(address);
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodedAddress}`, '_blank');
            } else {
                showMessage('Vui lòng cập nhật địa chỉ cửa hàng trong cài đặt trước.', 'info');
            }
        });
    </script>
</body>
</html>
